<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="John Graves">
<meta name="author" content="Shawn Garbett">
<meta name="dcterms.date" content="2025-05-26">

<title>Discrete Event Simulation for Health Decision Modeling</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="02-sick-sicker_files/libs/clipboard/clipboard.min.js"></script>
<script src="02-sick-sicker_files/libs/quarto-html/quarto.js"></script>
<script src="02-sick-sicker_files/libs/quarto-html/popper.min.js"></script>
<script src="02-sick-sicker_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="02-sick-sicker_files/libs/quarto-html/anchor.min.js"></script>
<link href="02-sick-sicker_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="02-sick-sicker_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="02-sick-sicker_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="02-sick-sicker_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="02-sick-sicker_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="02-sick-sicker_files/libs/quarto-contrib/intersection-observer-polyfill-1.0.0/intersection-observer.js"></script>
<script src="02-sick-sicker_files/libs/quarto-contrib/scrollama-3.2.0/scrollama.min.js"></script>
<script src="02-sick-sicker_files/libs/quarto-contrib/closeread-0.1.0/closeread.js"></script>
<script src="02-sick-sicker_files/libs/kePrint-0.0.1/kePrint.js"></script>
<link href="02-sick-sicker_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<meta cr-debug-mode="false">
<meta cr-remove-header-space="false">


<link rel="stylesheet" href="_extensions/qmd-lab/closeread/closeread.css">
<link rel="stylesheet" href="des-styling.css">
</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-full">

<main class="content page-columns page-full column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Discrete Event Simulation for Health Decision Modeling</h1>
<p class="subtitle lead">1. Introduction</p>
</div>


<div class="quarto-title-meta-author column-body">
  <div class="quarto-title-meta-heading">Authors</div>
  <div class="quarto-title-meta-heading">Affiliations</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">John Graves <a href="mailto:john.graves@vanderbilt.edu" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Vanderbilt University School of Medicine
          </p>
        <p class="affiliation">
            Vanderbilt Owen Gradute School of Management
          </p>
        <p class="affiliation">
            Vanderbilt University Medical Center
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Shawn Garbett <a href="mailto:shawn.garbett@vumc.org" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Vanderbilt University School of Medicine
          </p>
        <p class="affiliation">
            Vanderbilt University Medical Center
          </p>
      </div>
  </div>

<div class="quarto-title-meta column-body">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 26, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="model-1" class="level1 page-columns page-full">
<h1>Model 1</h1>
<div class="cr-section cr-column-screen overlay-center">
<div class="narrative-col">
<div class="trigger new-trigger" data-focus-on="cr-petri1">
<div class="narrative">
<p>A <span style="color:#007bdd"><strong>Petri Net diagram</strong></span> is a graphical modeling tool that represents the flow of resources, entities, and control through a DES over time. It’s particularly useful for modeling concurrent processes and shared resources.</p>
</div>
</div>
<div class="trigger new-trigger" data-pan-to="50%,50%" data-focus-on="cr-petri1" data-scale-by="2">
<div class="narrative">
<p>For our first (very simple!) DES we will model a system that initiates in a healthy state …</p>
</div>
</div>
<div class="trigger new-trigger" data-pan-to="50%,-50%" data-focus-on="cr-petri1" data-scale-by="2">
<div class="narrative">
<p>… and then follows patients for a defined 30-year time horizon.</p>
</div>
</div>
<div class="trigger new-trigger" data-pan-to="-50%,-50%" data-focus-on="cr-petri1" data-scale-by="1">
<div class="narrative">

</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-petri1">
<div class="narrative">

</div>
</div>
<div class="trigger">
<div class="narrative">
<p>Later, we will build up this very simple DES by incorporating additional components such as health state transitions, background mortality, and resource queues.</p>
</div>
</div>
</div>
<div class="sticky-col">
<div class="sticky-col-stack">
<div id="cr-petri1" class="sticky">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/petri-model1.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
<section id="counters" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="counters">Counters</h2>
<div class="column-screen" style="background-image:url(images/scoreboard-race.png); background-size: 100vw; height: 600px; background-position: center -55%; background-repeat: no-repeat; opacity: 0.5">

</div>
<figcaption>
Image generated by ChatGPT 4o
</figcaption>
<p>Think of a counter like a scoreboard that lists race times, including times for each lap (event) in the race. For our simple model, our counter will operate exactly like this—it will simply track the amount of time each patient spends in the model.</p>
<div class="cr-section cr-column-screen sidebar-left">
<div class="narrative-col">
<div class="trigger new-trigger" data-focus-on="cr-counters0">
<div class="narrative">
<p>Counters are defined as a vector object that provides the names of each event we want to track in the model. This vector will be used later with a convenience function we have written for <code>Simmer</code> ( <code>main_loop()</code>) to define resources with infinite capacity, i.e., there is no competition for a resource like “time in model”).</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-counters">
<div class="narrative">
<p>For this very simple model, we will simply track patients for a defined time horizon of 30 years. Thus, our first <code>counter</code> will be <code>time_in_model</code>.</p>
</div>
</div>
</div>
<div class="sticky-col">
<div class="sticky-col-stack">
<div id="cr-counters0" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>counters <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">#&lt;names of counters go here&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="cr-counters" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>counters <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"time_in_model"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="initializing-patients" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="initializing-patients">Initializing Patients</h2>
<p>We next need to define a process that will initialize patients in the model. Extending the racing analogy further, think of this process in terms of defining the pole positions of each “car” in the race: we want to define baseline attributes, like:</p>
<ul>
<li>Age</li>
<li>Disease status (e.g., healthy, ill)</li>
<li>Gender</li>
</ul>
<div class="column-screen" style="background-image:url(images/starting-line-cars2.png); background-size: 100vw; height: 500px; background-position: center bottom; background-repeat: no-repeat; opacity: 0.5">

</div>
<figcaption>
Image generated by ChatGPT 4o
</figcaption>
<div class="cr-section cr-column-screen overlay-center">
<div class="narrative-col">
<div class="trigger">
<div class="narrative">
<p>The pipe operator |&gt; in R is a tool for chaining operations together in a left-to-right, readable sequence. Instead of nesting functions or creating intermediate variables, you “pipe” the output of one function directly into the next function as its first argument.</p>
</div>
</div>
</div>
<div class="sticky-col">
<div class="sticky-col-stack">

</div>
</div>
</div>
<div class="cr-section cr-column-screen sidebar-right">
<div class="narrative-col">
<div class="trigger new-trigger" data-focus-on="cr-pipesyntax">
<div class="narrative">
<p>For example, this syntax using pipe operators … </p>
</div>
</div>
</div>
<div class="sticky-col">
<div class="sticky-col-stack">
<div id="cr-pipesyntax" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>data <span class="sc">|&gt;</span> <span class="fu">function1</span>() <span class="sc">|&gt;</span> <span class="fu">function2</span>() <span class="sc">|&gt;</span> <span class="fu">function3</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="cr-section cr-column-screen sidebar-right">
<div class="narrative-col">
<div class="trigger new-trigger" data-focus-on="cr-pipesyntax2">
<div class="narrative">
<p>is equivalent to: </p>
</div>
</div>
</div>
<div class="sticky-col">
<div class="sticky-col-stack">
<div id="cr-pipesyntax2" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">function3</span>(<span class="fu">function2</span>(<span class="fu">function1</span>(data)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</div>
<p>Let’s now define a function <code>initialize_patient()</code> to define the starting state of a patient. This can be as complex as needed to define the attributes of the starting population of a study.</p>
<div class="column-screen" style="background-image:url(images/starting-line-cars2.png); background-size: 100vw; height: 500px; background-position: center bottom; background-repeat: no-repeat; opacity: 0.25">

</div>
<div class="cr-section cr-column-screen sidebar-left">
<div class="narrative-col">
<div class="trigger new-trigger" data-focus-on="cr-initialize" data-highlight="1">
<div class="narrative">
<p>Our function has two inputs: <code>traj</code> and <code>inputs</code>.The object <code>inputs</code> are the parameters that define our model, and were defined above (and are also stored in <code>inputs.R</code>).</p>
</div>
</div>
<div class="trigger">
<div class="narrative">
<p>A trajectory (<code>traj</code>) is a sequence of events that defines what happens to people as they move through the DES. You can think of <code>traj</code> in terms of a personalized race course for each person in the model.</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-initialize" data-highlight="3">
<div class="narrative">
<p>In our code here, for a given patient we start with its trajectory</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-initialize" data-highlight="4">
<div class="narrative">
<p>We then feed this trajectory into the simmer function <code>seize()</code>.This function siezes the counter <code>time_in_model</code> that we defined above. You can think of this step in terms of taking our patient and directing them to the starting line of the simulation.</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-initialize" data-highlight="5">
<div class="narrative">
<p>The <code>initialize_patient()</code> function is also our opportunity to set baseline attributes of our patients. For example, here we sample the patient’s age in years from a uniform distribution between age 20 and 30.This attribute isn’t actually going to be used for now; we include it here simply to demonstrate how baseline attributes can be set. You can define as many of these attributes as needed to execute the model.</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-initialize">
<div class="narrative">

</div>
</div>
</div>
<div class="sticky-col">
<div class="sticky-col-stack">
<div id="cr-initialize" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>initialize_patient <span class="ot">&lt;-</span> <span class="cf">function</span>(traj, inputs)</span>
<span id="cb5-2"><a href="#cb5-2"></a>{</span>
<span id="cb5-3"><a href="#cb5-3"></a>  traj                   <span class="sc">|&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>  <span class="fu">seize</span>(<span class="st">"time_in_model"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>  <span class="fu">set_attribute</span>(<span class="st">"AgeInitial"</span>, <span class="cf">function</span>() <span class="fu">sample</span>(<span class="dv">20</span><span class="sc">:</span><span class="dv">30</span>, <span class="dv">1</span>))</span>
<span id="cb5-6"><a href="#cb5-6"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="cr-section cr-column-screen overlay-center">
<div class="narrative-col">
<div class="trigger new-trigger" data-focus-on="cr-initialize">
<div class="narrative">
<p><strong>NOTE</strong>: It is important when using simmer to mostly pass functions for defining things in a trajectory. This is a call back, and if not done properly it can result in puzzling behavior. If one passed to simmer the following: <code>sample(20:30,1)</code>, it would result in a single random draw applied to every single patient. For example, if 25 were draw every patient would be 25. Instead one needs to pass to simmer <code>function() sample(20:30,1)</code> to get a random draw for each patient resulting a uniform spread of this parameter. If every patient had the same attribute being assigned, it would be fine to leave off the <code>function()</code>, but this can lead to forgetting to do it in cases where it’s needed and it doesn’t hurt to leave it in on all calls.</p>
</div>
</div>
</div>
<div class="sticky-col">
<div class="sticky-col-stack">

</div>
</div>
</div>
</section>
<section id="define-the-finish-line" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="define-the-finish-line">Define the Finish Line</h2>
<p>The steps above were used to define the starting line and to define the dimensions we want to track and measure. The last step is to define where the model should end. That is, how do we define the “end” of the patient’s trajectory through the system? Once we define this end, we need to “release” the various counters (e.g., time in model) and resources we’ve defined.</p>
<p>We’ll do this using a series of “cleanup” functions that release the patient at the end of their journey through the model.</p>
<div class="column-screen" style="background-image:url(images/finish-line-cars.png); background-size: 100vw; height: 300px; background-position: center 35%; background-repeat: no-repeat; opacity: 0.5">

</div>
<figcaption>
Image generated by ChatGPT 4o
</figcaption>
<div class="cr-section cr-column-screen sidebar-left">
<div class="narrative-col">
<div class="trigger new-trigger" data-focus-on="cr-cleanup">
<div class="narrative">
<p>When a patient leaves the simulation via any means it is helpful to have a function that examines the state or attributes of that patient/trajectory and releases any resources they used.</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-cleanup" data-highlight="1-5">
<div class="narrative">
<p>In this section, we know they’ve seized <code>time_in_model</code>, so they need to let that go when they exit.</p>
</div>
</div>
<div class="trigger">
<div class="narrative">
<p>This function can get a lot more complex as patient state grows more complex.</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-cleanup" data-highlight="7-14">
<div class="narrative">
<p>This routine terminates the trajectory and calls the above cleanup. These two pieces could easily have been one function, but keeping them separate has proven useful in practice, primarily for organizational purposes.</p>
</div>
</div>
</div>
<div class="sticky-col">
<div class="sticky-col-stack">
<div id="cr-cleanup" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>cleanup_on_termination <span class="ot">&lt;-</span> <span class="cf">function</span>(traj)</span>
<span id="cb6-2"><a href="#cb6-2"></a>{</span>
<span id="cb6-3"><a href="#cb6-3"></a>  traj <span class="sc">|&gt;</span> </span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="fu">release</span>(<span class="st">"time_in_model"</span>)</span>
<span id="cb6-5"><a href="#cb6-5"></a>}</span>
<span id="cb6-6"><a href="#cb6-6"></a></span>
<span id="cb6-7"><a href="#cb6-7"></a>terminate_simulation <span class="ot">&lt;-</span> <span class="cf">function</span>(traj, inputs)</span>
<span id="cb6-8"><a href="#cb6-8"></a>{</span>
<span id="cb6-9"><a href="#cb6-9"></a>  traj <span class="sc">|&gt;</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>  <span class="fu">branch</span>( <span class="cf">function</span>() <span class="dv">1</span>, </span>
<span id="cb6-11"><a href="#cb6-11"></a>          <span class="at">continue=</span><span class="cn">FALSE</span>,</span>
<span id="cb6-12"><a href="#cb6-12"></a>          <span class="fu">trajectory</span>() <span class="sc">|&gt;</span> <span class="fu">cleanup_on_termination</span>()</span>
<span id="cb6-13"><a href="#cb6-13"></a>        )</span>
<span id="cb6-14"><a href="#cb6-14"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="event-registry" class="level2">
<h2 class="anchored" data-anchor-id="event-registry">Event Registry</h2>
<p>Now we’re approaching the heart of the model. The event registry. We’re going to define a single event to terminate the patient trajectory when the defined time horizon is reached. For a full life simulation such a function isn’t needed as a proper mortality model would have individuals simulated die at some point, however it’s not bad to have something like this to prevent a run away simulation.</p>
<div class="cr-section cr-column-screen sidebar-left">
<div class="narrative-col">
<div class="trigger new-trigger" data-focus-on="cr-registry">
<div class="narrative">
<p>Here’s how it looks for a single entry.</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-registry" data-highlight="2">
<div class="narrative">
<p>The <code>name</code> field is for debugging purposes and may come up on a simmer trace. It’s not used much in practice.</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-registry" data-highlight="3">
<div class="narrative">
<p><code>attr</code> is the name of the attribute on a patient used to store the time to event. It needs to be unique and not correspond to any other attribute name defined on the patient.</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-registry" data-highlight="4">
<div class="narrative">
<p><code>time_to_event</code> is a callback function that defines how long till the event occurs. Simulation time starts at 0 and proceeds forward.</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-registry" data-highlight="4">
<div class="narrative">
<p>In this model we have chosen the cycle to each a year. Thus when time reaches 2.0, that’s 2 years into the simulation for that patient—<em>not their age</em>.</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-registry" data-highlight="5">
<div class="narrative">
<p>The <code>func</code> is the callback function that will modify the state of the patient, in this case it’s the terminate simulation function defined above.</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-registry" data-highlight="6">
<div class="narrative">
<p>The <code>reactive</code> field is a logical TRUE/FALSE that defines whether all other events should be redraw if this event fires. In this case the patient trajectory is ending, so no events for them should be redrawn.</p>
</div>
</div>
</div>
<div class="sticky-col">
<div class="sticky-col-stack">
<div id="cr-registry" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>event_registry <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="fu">list</span>(<span class="at">name          =</span> <span class="st">"Terminate at time horizon"</span>,</span>
<span id="cb7-3"><a href="#cb7-3"></a>       <span class="at">attr          =</span> <span class="st">"aTerminate"</span>,</span>
<span id="cb7-4"><a href="#cb7-4"></a>       <span class="at">time_to_event =</span> <span class="cf">function</span>(inputs) inputs<span class="sc">$</span>horizon,</span>
<span id="cb7-5"><a href="#cb7-5"></a>       <span class="at">func          =</span> terminate_simulation,</span>
<span id="cb7-6"><a href="#cb7-6"></a>       <span class="at">reactive      =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-7"><a href="#cb7-7"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="tracking-outcomes" class="level2">
<h2 class="anchored" data-anchor-id="tracking-outcomes">Tracking Outcomes</h2>
<section id="quality-of-life-qol" class="level3">
<h3 class="anchored" data-anchor-id="quality-of-life-qol">Quality of Life (QoL)</h3>
<div class="cr-section cr-column-screen sidebar-left">
<div class="narrative-col">
<div class="trigger new-trigger" data-focus-on="cr-QoL">
<div class="narrative">

</div>
</div>
</div>
<div class="sticky-col">
<div class="sticky-col-stack">
<div id="cr-QoL" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>qaly_arrivals <span class="ot">&lt;-</span> <span class="cf">function</span>(arrivals, inputs)</span>
<span id="cb8-2"><a href="#cb8-2"></a>{</span>
<span id="cb8-3"><a href="#cb8-3"></a>  arrivals<span class="sc">$</span>qaly  <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># No qaly yet</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>  arrivals<span class="sc">$</span>dqaly <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># No discounted qaly either</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>  </span>
<span id="cb8-6"><a href="#cb8-6"></a>  selector <span class="ot">&lt;-</span> arrivals<span class="sc">$</span>resource <span class="sc">==</span> <span class="st">'time_in_model'</span></span>
<span id="cb8-7"><a href="#cb8-7"></a>  arrivals<span class="sc">$</span>qaly[selector] <span class="ot">&lt;-</span></span>
<span id="cb8-8"><a href="#cb8-8"></a>    arrivals<span class="sc">$</span>end_time[selector] <span class="sc">-</span> </span>
<span id="cb8-9"><a href="#cb8-9"></a>    arrivals<span class="sc">$</span>start_time[selector]</span>
<span id="cb8-10"><a href="#cb8-10"></a>  arrivals<span class="sc">$</span>dqaly[selector] <span class="ot">&lt;-</span> </span>
<span id="cb8-11"><a href="#cb8-11"></a>      <span class="fu">discount_value</span>(<span class="dv">1</span>, </span>
<span id="cb8-12"><a href="#cb8-12"></a>                     arrivals<span class="sc">$</span>start_time[selector],</span>
<span id="cb8-13"><a href="#cb8-13"></a>                     arrivals<span class="sc">$</span>end_time[selector])</span>
<span id="cb8-14"><a href="#cb8-14"></a>    </span>
<span id="cb8-15"><a href="#cb8-15"></a>  arrivals</span>
<span id="cb8-16"><a href="#cb8-16"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="costs" class="level3">
<h3 class="anchored" data-anchor-id="costs">Costs</h3>
<p>We need to define incured costs for our model. It should take the data.frame from <code>des_run</code> and add cost columns for the resources. We pass in the inputs as they might be needed. We will ignore the costs for healthy till we can add that state later.</p>
<div class="cr-section cr-column-screen sidebar-left">
<div class="narrative-col">
<div class="trigger new-trigger" data-focus-on="cr-costs">
<div class="narrative">

</div>
</div>
</div>
<div class="sticky-col">
<div class="sticky-col-stack">
<div id="cr-costs" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>cost_arrivals <span class="ot">&lt;-</span> <span class="cf">function</span>(arrivals, inputs)</span>
<span id="cb9-2"><a href="#cb9-2"></a>{</span>
<span id="cb9-3"><a href="#cb9-3"></a>  arrivals<span class="sc">$</span>cost  <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># No costs yet</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>  arrivals<span class="sc">$</span>dcost <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># No discounted costs either</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>  </span>
<span id="cb9-6"><a href="#cb9-6"></a>  arrivals</span>
<span id="cb9-7"><a href="#cb9-7"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="cr-section cr-column-screen sidebar-left">
<div class="narrative-col">
<div class="trigger new-trigger" data-focus-on="cr-desrun1">
<div class="narrative">
<p>The function <code>des_run</code> is the primary simulation function.</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-desrun1" data-highlight="3">
<div class="narrative">
<p>The first step is to create a global environment used to run simmer. This is followed by creating a des definition of a trajectory (this function is in <code>main_loop</code>. It uses the things we’ve defined above.</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-desrun1" data-highlight="4">
<div class="narrative">
<p>The patient trajectory (<code>traj</code>) is defined by our helper function <code>des()</code>, which can be found in <code>main_loop.R</code>. It essentially creates a patient, assigns attributes and events, and processes the events. Think of this function as the one that runs a single car through the race course.</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-desrun1" data-highlight="5-10">
<div class="narrative">
<p><code>env</code> is given resources or counters, patients are generated into the simulation, the simulation is run for an amount of time (just past the horizon) and then the <code>wrap</code> makes sure all summaries are ready.</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-desrun1" data-highlight="12">
<div class="narrative">
<p><code>get_mon_arrival</code> returns us the trajectories of the patients in a <code>data.frame</code>. We will expand on this quite a bit later. It really the soul of understanding what’s going on in a simulation and critical for auditing and validation of expectations about a model as we demonstrate later.</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-desrun1" data-highlight="13-14">
<div class="narrative">
<p>We add in cost and health outcomes.</p>
</div>
</div>
</div>
<div class="sticky-col">
<div class="sticky-col-stack">
<div id="cr-desrun1" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>des_run <span class="ot">&lt;-</span> <span class="cf">function</span>(inputs)</span>
<span id="cb10-2"><a href="#cb10-2"></a>{</span>
<span id="cb10-3"><a href="#cb10-3"></a>  env  <span class="ot">&lt;&lt;-</span> <span class="fu">simmer</span>(<span class="st">"SickSicker"</span>)</span>
<span id="cb10-4"><a href="#cb10-4"></a>  traj <span class="ot">&lt;-</span> <span class="fu">des</span>(env, inputs)</span>
<span id="cb10-5"><a href="#cb10-5"></a>  env <span class="sc">|&gt;</span> </span>
<span id="cb10-6"><a href="#cb10-6"></a>    <span class="fu">create_counters</span>(counters) <span class="sc">|&gt;</span></span>
<span id="cb10-7"><a href="#cb10-7"></a>    <span class="fu">add_generator</span>(<span class="st">"patient"</span>, traj, <span class="fu">at</span>(<span class="fu">rep</span>(<span class="dv">0</span>, inputs<span class="sc">$</span>N)), <span class="at">mon=</span><span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-8"><a href="#cb10-8"></a>    <span class="co"># Simulate just past horizon (in years)</span></span>
<span id="cb10-9"><a href="#cb10-9"></a>    <span class="fu">run</span>(inputs<span class="sc">$</span>horizon<span class="sc">+</span><span class="dv">1</span><span class="sc">/</span><span class="dv">365</span>) <span class="sc">|&gt;</span> </span>
<span id="cb10-10"><a href="#cb10-10"></a>    <span class="fu">wrap</span>()</span>
<span id="cb10-11"><a href="#cb10-11"></a>        </span>
<span id="cb10-12"><a href="#cb10-12"></a>  <span class="fu">get_mon_arrivals</span>(env, <span class="at">per_resource =</span> T) <span class="sc">|&gt;</span></span>
<span id="cb10-13"><a href="#cb10-13"></a>    <span class="fu">cost_arrivals</span>(inputs) <span class="sc">|&gt;</span> </span>
<span id="cb10-14"><a href="#cb10-14"></a>    <span class="fu">qaly_arrivals</span>(inputs) </span>
<span id="cb10-15"><a href="#cb10-15"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="model-2-a-simple-mortality-model" class="level1">
<h1>Model 2: A Simple Mortality Model</h1>
<p>Our first addition to the simple model will be to add background mortality.</p>
<div class="cr-section cr-column-screen overlay-center">
<div class="narrative-col">
<div class="trigger new-trigger" data-focus-on="cr-petri2">
<div class="narrative">

</div>
</div>
<div class="trigger new-trigger" data-pan-to="35%,50%" data-focus-on="cr-petri2" data-scale-by="1.5">
<div class="narrative">
<p>We have added the possibility of death as an event that can occur before the patient reaches the end of the time horizon …</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-petri2">
<div class="narrative">

</div>
</div>
</div>
<div class="sticky-col">
<div class="sticky-col-stack">
<div id="cr-petri2" class="sticky">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/petri-model2.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
<p>Our next objective is to add an event—death—to the model.</p>
<ol type="1">
<li>Add event to counter</li>
<li>Define function for time till event</li>
<li>Define function to mark and update the patient trajectory</li>
<li>Add event to event registry</li>
</ol>
<div class="cr-section cr-column-screen sidebar-left">
<div class="narrative-col">
<div class="trigger new-trigger" data-focus-on="cr-counter2">
<div class="narrative">
<p>Add death to the counter</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-yearstodeath">
<div class="narrative">
<p>Next we define a function to sample time till event</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-deathevent">
<div class="narrative">

</div>
</div>
<div class="trigger">
<div class="narrative">
<p>Net we define a function to mark and update the patient registry.</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-registry2">
<div class="narrative">

</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-registry2" data-highlight="7-11">
<div class="narrative">
<p>Finally, we add the event to the event registry.</p>
</div>
</div>
</div>
<div class="sticky-col">
<div class="sticky-col-stack">
<div id="cr-counter2" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>  counters <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb11-2"><a href="#cb11-2"></a>    <span class="st">"time_in_model"</span>,</span>
<span id="cb11-3"><a href="#cb11-3"></a>    <span class="st">"death"</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="cr-yearstodeath" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>years_till_death <span class="ot">&lt;-</span> <span class="cf">function</span>(inputs)</span>
<span id="cb12-2"><a href="#cb12-2"></a>{</span>
<span id="cb12-3"><a href="#cb12-3"></a>  <span class="fu">rexp</span>(<span class="dv">1</span>, inputs<span class="sc">$</span>r.HD)</span>
<span id="cb12-4"><a href="#cb12-4"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="cr-deathevent" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>death <span class="ot">&lt;-</span> <span class="cf">function</span>(traj, inputs)</span>
<span id="cb13-2"><a href="#cb13-2"></a>{</span>
<span id="cb13-3"><a href="#cb13-3"></a>  traj <span class="sc">|&gt;</span> <span class="fu">branch</span>(</span>
<span id="cb13-4"><a href="#cb13-4"></a>    <span class="cf">function</span>() <span class="dv">1</span>,</span>
<span id="cb13-5"><a href="#cb13-5"></a>    <span class="at">continue=</span><span class="fu">c</span>(<span class="cn">FALSE</span>), <span class="co"># False is patient death, had to use a branch to force termination</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>    <span class="fu">trajectory</span>(<span class="st">"Death"</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-7"><a href="#cb13-7"></a>      <span class="fu">mark</span>(<span class="st">"death"</span>)     <span class="sc">|&gt;</span> <span class="co"># Must be in 'counters'</span></span>
<span id="cb13-8"><a href="#cb13-8"></a>      <span class="fu">terminate_simulation</span>()</span>
<span id="cb13-9"><a href="#cb13-9"></a>  )</span>
<span id="cb13-10"><a href="#cb13-10"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="cr-registry2" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>event_registry <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb14-2"><a href="#cb14-2"></a>  <span class="fu">list</span>(<span class="at">name          =</span> <span class="st">"Terminate at time horizon"</span>,</span>
<span id="cb14-3"><a href="#cb14-3"></a>       <span class="at">attr          =</span> <span class="st">"aTerminate"</span>,</span>
<span id="cb14-4"><a href="#cb14-4"></a>       <span class="at">time_to_event =</span> <span class="cf">function</span>(inputs) inputs<span class="sc">$</span>horizon,</span>
<span id="cb14-5"><a href="#cb14-5"></a>       <span class="at">func          =</span> terminate_simulation,</span>
<span id="cb14-6"><a href="#cb14-6"></a>       <span class="at">reactive      =</span> <span class="cn">FALSE</span>),</span>
<span id="cb14-7"><a href="#cb14-7"></a>  <span class="fu">list</span>(<span class="at">name          =</span> <span class="st">"Death"</span>,</span>
<span id="cb14-8"><a href="#cb14-8"></a>       <span class="at">attr          =</span> <span class="st">"aDeath"</span>,</span>
<span id="cb14-9"><a href="#cb14-9"></a>       <span class="at">time_to_event =</span> years_till_death,</span>
<span id="cb14-10"><a href="#cb14-10"></a>       <span class="at">func          =</span> death,</span>
<span id="cb14-11"><a href="#cb14-11"></a>       <span class="at">reactive      =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-12"><a href="#cb14-12"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</div>
<p>Let’s run the model and look at the output.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">des_run</span>(inputs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cr-section cr-column-screen overlay-center">
<div class="narrative-col">
<div class="trigger new-trigger" data-focus-on="cr-res2_1">
<div class="narrative">

</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-res2_2">
<div class="narrative">
<p>Notice how this patient dies before the 30-year time horizon. The <code>resource</code> column indicates that the death event occurred for this patient, and the <code>start_time</code> column indicates the time at which the event occurred (7.25 years).</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-res2_3">
<div class="narrative">
<p>In total, and as a result of early death, this patient contributed 6.52 discounted QALYs to the simulated population.</p>
</div>
</div>
</div>
<div class="sticky-col">
<div class="sticky-col-stack">
<div id="cr-res2_1" class="sticky">
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">name</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">start_time</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">end_time</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">activity_time</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">resource</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">replication</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">cost</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">dcost</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">qaly</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">dqaly</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">patient4</td>
<td style="text-align: right;">7.24823</td>
<td style="text-align: right;">7.24823</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: left;">death</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">patient4</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">7.24823</td>
<td style="text-align: right;">7.24823</td>
<td style="text-align: left;">time_in_model</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">7.24823</td>
<td style="text-align: right;">6.524372</td>
</tr>
<tr class="odd">
<td style="text-align: left;">patient0</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: left;">time_in_model</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">19.893000</td>
</tr>
<tr class="even">
<td style="text-align: left;">patient1</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: left;">time_in_model</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">19.893000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">patient2</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: left;">time_in_model</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">19.893000</td>
</tr>
<tr class="even">
<td style="text-align: left;">patient3</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: left;">time_in_model</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">19.893000</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<div id="cr-res2_2" class="sticky">
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">name</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">start_time</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">end_time</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">activity_time</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">resource</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">replication</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">cost</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">dcost</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">qaly</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">dqaly</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left; background-color: rgba(255, 243, 205, 255) !important;">patient4</td>
<td style="text-align: right; background-color: rgba(255, 243, 205, 255) !important;">7.24823</td>
<td style="text-align: right; background-color: rgba(255, 243, 205, 255) !important;">7.24823</td>
<td style="text-align: right; background-color: rgba(255, 243, 205, 255) !important;">0.00000</td>
<td style="text-align: left; background-color: rgba(255, 243, 205, 255) !important;">death</td>
<td style="text-align: right; background-color: rgba(255, 243, 205, 255) !important;">1</td>
<td style="text-align: right; background-color: rgba(255, 243, 205, 255) !important;">0</td>
<td style="text-align: right; background-color: rgba(255, 243, 205, 255) !important;">0</td>
<td style="text-align: right; background-color: rgba(255, 243, 205, 255) !important;">0.00000</td>
<td style="text-align: right; background-color: rgba(255, 243, 205, 255) !important;">0.000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">patient4</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">7.24823</td>
<td style="text-align: right;">7.24823</td>
<td style="text-align: left;">time_in_model</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">7.24823</td>
<td style="text-align: right;">6.524372</td>
</tr>
<tr class="odd">
<td style="text-align: left;">patient0</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: left;">time_in_model</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">19.893000</td>
</tr>
<tr class="even">
<td style="text-align: left;">patient1</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: left;">time_in_model</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">19.893000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">patient2</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: left;">time_in_model</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">19.893000</td>
</tr>
<tr class="even">
<td style="text-align: left;">patient3</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: left;">time_in_model</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">19.893000</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<div id="cr-res2_3" class="sticky">
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">name</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">start_time</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">end_time</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">activity_time</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">resource</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">replication</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">cost</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">dcost</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">qaly</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">dqaly</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">patient4</td>
<td style="text-align: right;">7.24823</td>
<td style="text-align: right;">7.24823</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: left;">death</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="even">
<td style="text-align: left; background-color: rgba(255, 243, 205, 255) !important;">patient4</td>
<td style="text-align: right; background-color: rgba(255, 243, 205, 255) !important;">0.00000</td>
<td style="text-align: right; background-color: rgba(255, 243, 205, 255) !important;">7.24823</td>
<td style="text-align: right; background-color: rgba(255, 243, 205, 255) !important;">7.24823</td>
<td style="text-align: left; background-color: rgba(255, 243, 205, 255) !important;">time_in_model</td>
<td style="text-align: right; background-color: rgba(255, 243, 205, 255) !important;">1</td>
<td style="text-align: right; background-color: rgba(255, 243, 205, 255) !important;">0</td>
<td style="text-align: right; background-color: rgba(255, 243, 205, 255) !important;">0</td>
<td style="text-align: right; background-color: rgba(255, 243, 205, 255) !important;">7.24823</td>
<td style="text-align: right; background-color: rgba(255, 243, 205, 255) !important;">6.524372</td>
</tr>
<tr class="odd">
<td style="text-align: left;">patient0</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: left;">time_in_model</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">19.893000</td>
</tr>
<tr class="even">
<td style="text-align: left;">patient1</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: left;">time_in_model</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">19.893000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">patient2</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: left;">time_in_model</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">19.893000</td>
</tr>
<tr class="even">
<td style="text-align: left;">patient3</td>
<td style="text-align: right;">0.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: left;">time_in_model</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">30.00000</td>
<td style="text-align: right;">19.893000</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="model-3-adding-in-a-sick-state" class="level1">
<h1>Model 3: Adding in a Sick State</h1>
<p>Our next addition is to add disease incidence to the model.</p>
<div class="cr-section cr-column-screen overlay-center">
<div class="narrative-col">
<div class="trigger new-trigger" data-focus-on="cr-petri3">
<div class="narrative">

</div>
</div>
<div class="trigger new-trigger" data-pan-to="35%,30%" data-focus-on="cr-petri3" data-scale-by="1.5">
<div class="narrative">
<p>We have added the possibility of transitions to a diseased state (“S”) a …</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-petri3">
<div class="narrative">

</div>
</div>
</div>
<div class="sticky-col">
<div class="sticky-col-stack">
<div id="cr-petri3" class="sticky">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/petri-model3.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
<div class="cr-section cr-column-screen sidebar-left">
<div class="narrative-col">
<div class="trigger new-trigger" data-focus-on="cr-statelut">
<div class="narrative">
<p>Need a lookup table for numeric mapping to health states.</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-counters3">
<div class="narrative">
<p>Update counters</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-sick3">
<div class="narrative">
<p>Need to define functions for the event of getting sick</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-death3">
<div class="narrative">
<p>Also need to update death event to account for higher risk of death</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-outcomes3_1">
<div class="narrative">
<p>And update QoL and Costs to account for costs and utility weight while sick</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-outcomes3_2">
<div class="narrative">
<p>Then</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-registry3">
<div class="narrative">
<p>Now update event registry</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-initialize3">
<div class="narrative">
<p>Next we need to modify the initialization of the patient to be healthy.</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-cleanup3">
<div class="narrative">
<p>Need to update cleanup</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-run3">
<div class="narrative">
<p>And finally, update the model run code</p>
</div>
</div>
</div>
<div class="sticky-col">
<div class="sticky-col-stack">
<div id="cr-statelut" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>state_lut <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb16-2"><a href="#cb16-2"></a>  <span class="st">"0"</span> <span class="ot">=</span> <span class="st">"H"</span>,</span>
<span id="cb16-3"><a href="#cb16-3"></a>  <span class="st">"1"</span> <span class="ot">=</span> <span class="st">"S1"</span>,</span>
<span id="cb16-4"><a href="#cb16-4"></a>  <span class="st">"2"</span> <span class="ot">=</span> <span class="st">"S2"</span></span>
<span id="cb16-5"><a href="#cb16-5"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="cr-counters3" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>counters <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb17-2"><a href="#cb17-2"></a>  <span class="st">"time_in_model"</span>,</span>
<span id="cb17-3"><a href="#cb17-3"></a>  <span class="st">"death"</span>,</span>
<span id="cb17-4"><a href="#cb17-4"></a>  <span class="st">"healthy"</span>,</span>
<span id="cb17-5"><a href="#cb17-5"></a>  <span class="st">"sick1"</span></span>
<span id="cb17-6"><a href="#cb17-6"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="cr-sick3" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>years_till_sick1 <span class="ot">&lt;-</span> <span class="cf">function</span>(inputs)</span>
<span id="cb18-2"><a href="#cb18-2"></a>{</span>
<span id="cb18-3"><a href="#cb18-3"></a>  state <span class="ot">&lt;-</span> <span class="fu">get_attribute</span>(env, <span class="st">"State"</span>) </span>
<span id="cb18-4"><a href="#cb18-4"></a>  <span class="cf">if</span>(state <span class="sc">==</span> <span class="dv">0</span>) <span class="co"># 0 =&gt; Healthy</span></span>
<span id="cb18-5"><a href="#cb18-5"></a>  {</span>
<span id="cb18-6"><a href="#cb18-6"></a>    <span class="fu">rexp</span>(<span class="dv">1</span>,inputs<span class="sc">$</span>r.HS1)</span>
<span id="cb18-7"><a href="#cb18-7"></a>  } <span class="cf">else</span></span>
<span id="cb18-8"><a href="#cb18-8"></a>  {</span>
<span id="cb18-9"><a href="#cb18-9"></a>    inputs<span class="sc">$</span>horizon<span class="sc">+</span><span class="dv">1</span> <span class="co"># Past end of simulation time</span></span>
<span id="cb18-10"><a href="#cb18-10"></a>  }</span>
<span id="cb18-11"><a href="#cb18-11"></a>}</span>
<span id="cb18-12"><a href="#cb18-12"></a></span>
<span id="cb18-13"><a href="#cb18-13"></a>sick1 <span class="ot">&lt;-</span> <span class="cf">function</span>(traj, inputs)</span>
<span id="cb18-14"><a href="#cb18-14"></a>{</span>
<span id="cb18-15"><a href="#cb18-15"></a>  traj                      <span class="sc">|&gt;</span> </span>
<span id="cb18-16"><a href="#cb18-16"></a>  <span class="fu">set_attribute</span>(<span class="st">"State"</span>, <span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="co"># 1 =&gt; Sick 1 (S1)</span></span>
<span id="cb18-17"><a href="#cb18-17"></a>  <span class="fu">release</span>(<span class="st">'healthy'</span>)        <span class="sc">|&gt;</span> <span class="co"># Track state change for tally later</span></span>
<span id="cb18-18"><a href="#cb18-18"></a>  <span class="fu">seize</span>(<span class="st">'sick1'</span>)</span>
<span id="cb18-19"><a href="#cb18-19"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="cr-death3" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>years_till_death <span class="ot">&lt;-</span> <span class="cf">function</span>(inputs)</span>
<span id="cb19-2"><a href="#cb19-2"></a>{</span>
<span id="cb19-3"><a href="#cb19-3"></a>  state <span class="ot">&lt;-</span> <span class="fu">get_attribute</span>(env, <span class="st">"State"</span>)</span>
<span id="cb19-4"><a href="#cb19-4"></a>  rate <span class="ot">&lt;-</span> inputs<span class="sc">$</span>r.HD</span>
<span id="cb19-5"><a href="#cb19-5"></a>  <span class="cf">if</span>(state <span class="sc">==</span> <span class="dv">1</span>) rate <span class="ot">&lt;-</span> rate <span class="sc">*</span> inputs<span class="sc">$</span>hr.S1D <span class="co"># Deal with Sick1 Hazard Ratio</span></span>
<span id="cb19-6"><a href="#cb19-6"></a>  <span class="fu">rexp</span>(<span class="dv">1</span>, rate)</span>
<span id="cb19-7"><a href="#cb19-7"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="cr-outcomes3_1" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>cost_arrivals <span class="ot">&lt;-</span> <span class="cf">function</span>(arrivals, inputs)</span>
<span id="cb20-2"><a href="#cb20-2"></a>{</span>
<span id="cb20-3"><a href="#cb20-3"></a>  arrivals<span class="sc">$</span>cost  <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># No costs yet</span></span>
<span id="cb20-4"><a href="#cb20-4"></a>  arrivals<span class="sc">$</span>dcost <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># No discounted costs either</span></span>
<span id="cb20-5"><a href="#cb20-5"></a>  </span>
<span id="cb20-6"><a href="#cb20-6"></a>  selector <span class="ot">=</span> arrivals<span class="sc">$</span>resource <span class="sc">==</span> <span class="st">'healthy'</span></span>
<span id="cb20-7"><a href="#cb20-7"></a>  arrivals<span class="sc">$</span>cost[selector] <span class="ot">&lt;-</span> inputs<span class="sc">$</span>c.H <span class="sc">*</span></span>
<span id="cb20-8"><a href="#cb20-8"></a>    (arrivals<span class="sc">$</span>end_time[selector] <span class="sc">-</span> arrivals<span class="sc">$</span>start_time[selector])</span>
<span id="cb20-9"><a href="#cb20-9"></a>  arrivals<span class="sc">$</span>dcost[selector] <span class="ot">&lt;-</span> <span class="fu">discount_value</span>(inputs<span class="sc">$</span>c.H,</span>
<span id="cb20-10"><a href="#cb20-10"></a>    arrivals<span class="sc">$</span>start_time[selector], arrivals<span class="sc">$</span>end_time[selector])</span>
<span id="cb20-11"><a href="#cb20-11"></a>  </span>
<span id="cb20-12"><a href="#cb20-12"></a>  selector <span class="ot">=</span> arrivals<span class="sc">$</span>resource <span class="sc">==</span> <span class="st">'sick1'</span></span>
<span id="cb20-13"><a href="#cb20-13"></a>  arrivals<span class="sc">$</span>cost[selector] <span class="ot">&lt;-</span> inputs<span class="sc">$</span>c.S1 <span class="sc">*</span></span>
<span id="cb20-14"><a href="#cb20-14"></a>    (arrivals<span class="sc">$</span>end_time[selector] <span class="sc">-</span> arrivals<span class="sc">$</span>start_time[selector])</span>
<span id="cb20-15"><a href="#cb20-15"></a>  arrivals<span class="sc">$</span>dcost[selector] <span class="ot">&lt;-</span> <span class="fu">discount_value</span>(inputs<span class="sc">$</span>c.S1,</span>
<span id="cb20-16"><a href="#cb20-16"></a>    arrivals<span class="sc">$</span>start_time[selector], arrivals<span class="sc">$</span>end_time[selector])</span>
<span id="cb20-17"><a href="#cb20-17"></a> </span>
<span id="cb20-18"><a href="#cb20-18"></a>  arrivals</span>
<span id="cb20-19"><a href="#cb20-19"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="cr-outcomes3_2" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>qaly_arrivals <span class="ot">&lt;-</span> <span class="cf">function</span>(arrivals, inputs)</span>
<span id="cb21-2"><a href="#cb21-2"></a>{</span>
<span id="cb21-3"><a href="#cb21-3"></a>  arrivals<span class="sc">$</span>qaly  <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># No qaly yet</span></span>
<span id="cb21-4"><a href="#cb21-4"></a>  arrivals<span class="sc">$</span>dqaly <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># No discounted qaly either</span></span>
<span id="cb21-5"><a href="#cb21-5"></a>  </span>
<span id="cb21-6"><a href="#cb21-6"></a>  selector <span class="ot">&lt;-</span> arrivals<span class="sc">$</span>resource <span class="sc">==</span> <span class="st">'healthy'</span></span>
<span id="cb21-7"><a href="#cb21-7"></a>  arrivals<span class="sc">$</span>qaly[selector] <span class="ot">&lt;-</span></span>
<span id="cb21-8"><a href="#cb21-8"></a>    inputs<span class="sc">$</span>u.H<span class="sc">*</span></span>
<span id="cb21-9"><a href="#cb21-9"></a>     (arrivals<span class="sc">$</span>end_time[selector] <span class="sc">-</span> arrivals<span class="sc">$</span>start_time[selector])</span>
<span id="cb21-10"><a href="#cb21-10"></a>  arrivals<span class="sc">$</span>dqaly[selector] <span class="ot">&lt;-</span> </span>
<span id="cb21-11"><a href="#cb21-11"></a>      <span class="fu">discount_value</span>(inputs<span class="sc">$</span>u.H, </span>
<span id="cb21-12"><a href="#cb21-12"></a>                     arrivals<span class="sc">$</span>start_time[selector],</span>
<span id="cb21-13"><a href="#cb21-13"></a>                     arrivals<span class="sc">$</span>end_time[selector])</span>
<span id="cb21-14"><a href="#cb21-14"></a>  </span>
<span id="cb21-15"><a href="#cb21-15"></a>  selector <span class="ot">&lt;-</span> arrivals<span class="sc">$</span>resource <span class="sc">==</span> <span class="st">'sick1'</span></span>
<span id="cb21-16"><a href="#cb21-16"></a>  arrivals<span class="sc">$</span>qaly[selector] <span class="ot">&lt;-</span></span>
<span id="cb21-17"><a href="#cb21-17"></a>    inputs<span class="sc">$</span>u.S1<span class="sc">*</span></span>
<span id="cb21-18"><a href="#cb21-18"></a>     (arrivals<span class="sc">$</span>end_time[selector] <span class="sc">-</span> arrivals<span class="sc">$</span>start_time[selector])</span>
<span id="cb21-19"><a href="#cb21-19"></a>  arrivals<span class="sc">$</span>dqaly[selector] <span class="ot">&lt;-</span> </span>
<span id="cb21-20"><a href="#cb21-20"></a>      <span class="fu">discount_value</span>(inputs<span class="sc">$</span>u.S1, </span>
<span id="cb21-21"><a href="#cb21-21"></a>                     arrivals<span class="sc">$</span>start_time[selector],</span>
<span id="cb21-22"><a href="#cb21-22"></a>                     arrivals<span class="sc">$</span>end_time[selector])</span>
<span id="cb21-23"><a href="#cb21-23"></a>  </span>
<span id="cb21-24"><a href="#cb21-24"></a>  arrivals</span>
<span id="cb21-25"><a href="#cb21-25"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="cr-registry3" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>event_registry <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb22-2"><a href="#cb22-2"></a>  <span class="fu">list</span>(<span class="at">name          =</span> <span class="st">"Terminate at time horizon"</span>,</span>
<span id="cb22-3"><a href="#cb22-3"></a>       <span class="at">attr          =</span> <span class="st">"aTerminate"</span>,</span>
<span id="cb22-4"><a href="#cb22-4"></a>       <span class="at">time_to_event =</span> <span class="cf">function</span>(inputs) inputs<span class="sc">$</span>horizon<span class="sc">-</span><span class="fu">now</span>(env),</span>
<span id="cb22-5"><a href="#cb22-5"></a>       <span class="at">func          =</span> terminate_simulation,</span>
<span id="cb22-6"><a href="#cb22-6"></a>       <span class="at">reactive      =</span> <span class="cn">FALSE</span>),</span>
<span id="cb22-7"><a href="#cb22-7"></a>  <span class="fu">list</span>(<span class="at">name          =</span> <span class="st">"Death"</span>,</span>
<span id="cb22-8"><a href="#cb22-8"></a>       <span class="at">attr          =</span> <span class="st">"aDeath"</span>,</span>
<span id="cb22-9"><a href="#cb22-9"></a>       <span class="at">time_to_event =</span> years_till_death,</span>
<span id="cb22-10"><a href="#cb22-10"></a>       <span class="at">func          =</span> death,</span>
<span id="cb22-11"><a href="#cb22-11"></a>       <span class="at">reactive      =</span> <span class="cn">TRUE</span>),</span>
<span id="cb22-12"><a href="#cb22-12"></a>  <span class="fu">list</span>(<span class="at">name          =</span> <span class="st">"Sick1"</span>,</span>
<span id="cb22-13"><a href="#cb22-13"></a>       <span class="at">attr          =</span> <span class="st">"aSick1"</span>,</span>
<span id="cb22-14"><a href="#cb22-14"></a>       <span class="at">time_to_event =</span> years_till_sick1,</span>
<span id="cb22-15"><a href="#cb22-15"></a>       <span class="at">func          =</span> sick1,</span>
<span id="cb22-16"><a href="#cb22-16"></a>       <span class="at">reactive      =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-17"><a href="#cb22-17"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="cr-initialize3" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>initialize_patient <span class="ot">&lt;-</span> <span class="cf">function</span>(traj, inputs)</span>
<span id="cb23-2"><a href="#cb23-2"></a>{</span>
<span id="cb23-3"><a href="#cb23-3"></a>  traj                   <span class="sc">|&gt;</span></span>
<span id="cb23-4"><a href="#cb23-4"></a>  <span class="fu">seize</span>(<span class="st">"time_in_model"</span>) <span class="sc">|&gt;</span></span>
<span id="cb23-5"><a href="#cb23-5"></a>  <span class="fu">set_attribute</span>(<span class="st">"AgeInitial"</span>, <span class="cf">function</span>() <span class="fu">sample</span>(<span class="dv">20</span><span class="sc">:</span><span class="dv">30</span>, <span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb23-6"><a href="#cb23-6"></a>  <span class="fu">set_attribute</span>(<span class="st">"State"</span>, <span class="dv">0</span>) <span class="sc">|&gt;</span> <span class="co"># Patients start healthy</span></span>
<span id="cb23-7"><a href="#cb23-7"></a>  <span class="fu">seize</span>(<span class="st">"healthy"</span>) </span>
<span id="cb23-8"><a href="#cb23-8"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="cr-cleanup3" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>cleanup_on_termination <span class="ot">&lt;-</span> <span class="cf">function</span>(traj)</span>
<span id="cb24-2"><a href="#cb24-2"></a>{</span>
<span id="cb24-3"><a href="#cb24-3"></a>  traj <span class="sc">|&gt;</span> </span>
<span id="cb24-4"><a href="#cb24-4"></a>  <span class="fu">release</span>(<span class="st">"time_in_model"</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-5"><a href="#cb24-5"></a>  <span class="fu">branch</span>( </span>
<span id="cb24-6"><a href="#cb24-6"></a>    <span class="cf">function</span>() <span class="fu">get_attribute</span>(env, <span class="st">"State"</span>)<span class="sc">+</span><span class="dv">1</span>,</span>
<span id="cb24-7"><a href="#cb24-7"></a>      <span class="at">continue =</span> <span class="fu">rep</span>(<span class="cn">TRUE</span>, <span class="dv">3</span>),</span>
<span id="cb24-8"><a href="#cb24-8"></a>      <span class="fu">trajectory</span>() <span class="sc">|&gt;</span> <span class="fu">release</span>(<span class="st">"healthy"</span>),</span>
<span id="cb24-9"><a href="#cb24-9"></a>      <span class="fu">trajectory</span>() <span class="sc">|&gt;</span> <span class="fu">release</span>(<span class="st">"sick1"</span>), <span class="co"># Leaving sick1 state on termination</span></span>
<span id="cb24-10"><a href="#cb24-10"></a>      <span class="fu">trajectory</span>()      <span class="co"># Future Sick2 state</span></span>
<span id="cb24-11"><a href="#cb24-11"></a>  )</span>
<span id="cb24-12"><a href="#cb24-12"></a>}</span>
<span id="cb24-13"><a href="#cb24-13"></a></span>
<span id="cb24-14"><a href="#cb24-14"></a>terminate_simulation <span class="ot">&lt;-</span> <span class="cf">function</span>(traj, inputs)</span>
<span id="cb24-15"><a href="#cb24-15"></a>{</span>
<span id="cb24-16"><a href="#cb24-16"></a>  traj <span class="sc">|&gt;</span></span>
<span id="cb24-17"><a href="#cb24-17"></a>  <span class="fu">branch</span>( <span class="cf">function</span>() <span class="dv">1</span>, </span>
<span id="cb24-18"><a href="#cb24-18"></a>          <span class="at">continue=</span><span class="cn">FALSE</span>,</span>
<span id="cb24-19"><a href="#cb24-19"></a>          <span class="fu">trajectory</span>() <span class="sc">|&gt;</span> <span class="fu">cleanup_on_termination</span>()</span>
<span id="cb24-20"><a href="#cb24-20"></a>        )</span>
<span id="cb24-21"><a href="#cb24-21"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="cr-run3" class="sticky">
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>des_run <span class="ot">&lt;-</span> <span class="cf">function</span>(inputs)</span>
<span id="cb25-2"><a href="#cb25-2"></a>{</span>
<span id="cb25-3"><a href="#cb25-3"></a>  env  <span class="ot">&lt;&lt;-</span> <span class="fu">simmer</span>(<span class="st">"SickSicker"</span>)</span>
<span id="cb25-4"><a href="#cb25-4"></a>  traj <span class="ot">&lt;-</span> <span class="fu">des</span>(env, inputs)</span>
<span id="cb25-5"><a href="#cb25-5"></a>  env <span class="sc">|&gt;</span> </span>
<span id="cb25-6"><a href="#cb25-6"></a>    <span class="fu">create_counters</span>(counters) <span class="sc">|&gt;</span></span>
<span id="cb25-7"><a href="#cb25-7"></a>    <span class="fu">add_generator</span>(<span class="st">"patient"</span>, traj, <span class="fu">at</span>(<span class="fu">rep</span>(<span class="dv">0</span>, inputs<span class="sc">$</span>N)), <span class="at">mon=</span><span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<span id="cb25-8"><a href="#cb25-8"></a>    <span class="fu">run</span>(inputs<span class="sc">$</span>horizon<span class="sc">+</span><span class="dv">1</span><span class="sc">/</span><span class="dv">365</span>) <span class="sc">|&gt;</span> <span class="co"># Simulate just past horizon (in years)</span></span>
<span id="cb25-9"><a href="#cb25-9"></a>    <span class="fu">wrap</span>()</span>
<span id="cb25-10"><a href="#cb25-10"></a>        </span>
<span id="cb25-11"><a href="#cb25-11"></a>  <span class="fu">get_mon_arrivals</span>(env, <span class="at">per_resource =</span> T) <span class="sc">|&gt;</span></span>
<span id="cb25-12"><a href="#cb25-12"></a>    <span class="fu">cost_arrivals</span>(inputs) <span class="sc">|&gt;</span> </span>
<span id="cb25-13"><a href="#cb25-13"></a>    <span class="fu">qaly_arrivals</span>(inputs) </span>
<span id="cb25-14"><a href="#cb25-14"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">name</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">start_time</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">end_time</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">activity_time</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">resource</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">replication</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">cost</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">dcost</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">qaly</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">dqaly</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">patient3</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0669855</td>
<td style="text-align: right;">0.0669855</td>
<td style="text-align: left;">healthy</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">133.971</td>
<td style="text-align: right;">133.8385</td>
<td style="text-align: right;">0.0669855</td>
<td style="text-align: right;">0.0669192</td>
</tr>
<tr class="even">
<td style="text-align: left;">patient4</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.5150044</td>
<td style="text-align: right;">0.5150044</td>
<td style="text-align: left;">healthy</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1030.009</td>
<td style="text-align: right;">1022.2086</td>
<td style="text-align: right;">0.5150044</td>
<td style="text-align: right;">0.5111043</td>
</tr>
<tr class="odd">
<td style="text-align: left;">patient2</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">1.0347989</td>
<td style="text-align: right;">1.0347989</td>
<td style="text-align: left;">healthy</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2069.598</td>
<td style="text-align: right;">2038.2663</td>
<td style="text-align: right;">1.0347989</td>
<td style="text-align: right;">1.0191331</td>
</tr>
<tr class="even">
<td style="text-align: left;">patient1</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">1.3919207</td>
<td style="text-align: right;">1.3919207</td>
<td style="text-align: left;">healthy</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2783.841</td>
<td style="text-align: right;">2727.3503</td>
<td style="text-align: right;">1.3919207</td>
<td style="text-align: right;">1.3636752</td>
</tr>
<tr class="odd">
<td style="text-align: left;">patient0</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">8.2194439</td>
<td style="text-align: right;">8.2194439</td>
<td style="text-align: left;">healthy</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">16438.888</td>
<td style="text-align: right;">14594.2785</td>
<td style="text-align: right;">8.2194439</td>
<td style="text-align: right;">7.2971393</td>
</tr>
<tr class="even">
<td style="text-align: left;">patient4</td>
<td style="text-align: right;">11.0601705</td>
<td style="text-align: right;">11.0601705</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: left;">death</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">patient4</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">11.0601705</td>
<td style="text-align: right;">11.0601705</td>
<td style="text-align: left;">time_in_model</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">patient4</td>
<td style="text-align: right;">0.5150044</td>
<td style="text-align: right;">11.0601705</td>
<td style="text-align: right;">10.5451660</td>
<td style="text-align: left;">sick1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">42180.664</td>
<td style="text-align: right;">35692.2209</td>
<td style="text-align: right;">8.4361328</td>
<td style="text-align: right;">7.1384442</td>
</tr>
<tr class="odd">
<td style="text-align: left;">patient0</td>
<td style="text-align: right;">21.5169860</td>
<td style="text-align: right;">21.5169860</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: left;">death</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">patient0</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">21.5169860</td>
<td style="text-align: right;">21.5169860</td>
<td style="text-align: left;">time_in_model</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">patient0</td>
<td style="text-align: right;">8.2194439</td>
<td style="text-align: right;">21.5169860</td>
<td style="text-align: right;">13.2975421</td>
<td style="text-align: left;">sick1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">53190.168</td>
<td style="text-align: right;">34495.0557</td>
<td style="text-align: right;">10.6380337</td>
<td style="text-align: right;">6.8990111</td>
</tr>
<tr class="even">
<td style="text-align: left;">patient3</td>
<td style="text-align: right;">27.2254334</td>
<td style="text-align: right;">27.2254334</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: left;">death</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">patient3</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">27.2254334</td>
<td style="text-align: right;">27.2254334</td>
<td style="text-align: left;">time_in_model</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">patient3</td>
<td style="text-align: right;">0.0669855</td>
<td style="text-align: right;">27.2254334</td>
<td style="text-align: right;">27.1584479</td>
<td style="text-align: left;">sick1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">108633.791</td>
<td style="text-align: right;">74539.2546</td>
<td style="text-align: right;">21.7267583</td>
<td style="text-align: right;">14.9078509</td>
</tr>
<tr class="odd">
<td style="text-align: left;">patient2</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">30.0000000</td>
<td style="text-align: right;">30.0000000</td>
<td style="text-align: left;">time_in_model</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">patient1</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">30.0000000</td>
<td style="text-align: right;">30.0000000</td>
<td style="text-align: left;">time_in_model</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.0000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">patient2</td>
<td style="text-align: right;">1.0347989</td>
<td style="text-align: right;">30.0000000</td>
<td style="text-align: right;">28.9652011</td>
<td style="text-align: left;">sick1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">115860.804</td>
<td style="text-align: right;">75495.4658</td>
<td style="text-align: right;">23.1721609</td>
<td style="text-align: right;">15.0990932</td>
</tr>
<tr class="even">
<td style="text-align: left;">patient1</td>
<td style="text-align: right;">1.3919207</td>
<td style="text-align: right;">30.0000000</td>
<td style="text-align: right;">28.6080793</td>
<td style="text-align: left;">sick1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">114432.317</td>
<td style="text-align: right;">74117.2976</td>
<td style="text-align: right;">22.8864634</td>
<td style="text-align: right;">14.8234595</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="model-4-add-recovery" class="level1">
<h1>Model 4: Add Recovery</h1>
<p>Our next addition is to add disease recovery to the model.</p>
<div class="cr-section cr-column-screen overlay-center">
<div class="narrative-col">
<div class="trigger new-trigger" data-focus-on="cr-petri4">
<div class="narrative">

</div>
</div>
<div class="trigger new-trigger" data-pan-to="35%,30%" data-focus-on="cr-petri4" data-scale-by="1.5">
<div class="narrative">
<p>We have added the possibility of recovery …</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-petri4">
<div class="narrative">

</div>
</div>
</div>
<div class="sticky-col">
<div class="sticky-col-stack">
<div id="cr-petri4" class="sticky">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/petri-model4.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="model-5-add-recovery" class="level1">
<h1>Model 5: Add Recovery</h1>
<p>Our next addition is to add disease progression to the model.</p>
<div class="cr-section cr-column-screen overlay-center">
<div class="narrative-col">
<div class="trigger new-trigger" data-focus-on="cr-petri5">
<div class="narrative">

</div>
</div>
<div class="trigger new-trigger" data-pan-to="35%,30%" data-focus-on="cr-petri5" data-scale-by="1.5">
<div class="narrative">
<p>We have added the possibility of disease progression …</p>
</div>
</div>
<div class="trigger new-trigger" data-focus-on="cr-petri5">
<div class="narrative">

</div>
</div>
</div>
<div class="sticky-col">
<div class="sticky-col-stack">
<div id="cr-petri5" class="sticky">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/petri-model4.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>