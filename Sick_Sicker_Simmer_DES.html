<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.340">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Shawn Garbett">
<meta name="dcterms.date" content="2025-01-23">

<title>Sick Sicker Simmer DES</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Sick_Sicker_Simmer_DES_files/libs/clipboard/clipboard.min.js"></script>
<script src="Sick_Sicker_Simmer_DES_files/libs/quarto-html/quarto.js"></script>
<script src="Sick_Sicker_Simmer_DES_files/libs/quarto-html/popper.min.js"></script>
<script src="Sick_Sicker_Simmer_DES_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Sick_Sicker_Simmer_DES_files/libs/quarto-html/anchor.min.js"></script>
<link href="Sick_Sicker_Simmer_DES_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Sick_Sicker_Simmer_DES_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Sick_Sicker_Simmer_DES_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Sick_Sicker_Simmer_DES_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Sick_Sicker_Simmer_DES_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Sick Sicker Simmer DES</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Shawn Garbett </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 23, 2025</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="goal" class="level2">
<h2 class="anchored" data-anchor-id="goal">Goal</h2>
<p>Sick/Sicker implemented in DES using R.</p>
<p>The Sick/Sicker model is a common reference model used by the Health Policy community as a learning example about methods. The <a href="https://cran.r-project.org/package=simmer">simmer</a> R package provides a discrete event simulation (DES) framework for running DES simulations in the R environment. The purpose of this document is to show how to progressively build a DES Health Policy model, the Sick/Sicker model using these tools.</p>
<blockquote class="blockquote">
<p><em>“Practice yourself, for heaven’s sake in little things, and then proceed to greater.”</em> –Epictetus</p>
</blockquote>
<p>The structure of this is to provide the simplest possible series of steps to constructing a Sick/Sicker model using <a href="https://cran.r-project.org/package=simmer">simmer</a></p>
</section>
<section id="des-health-policy-terminology-mapping" class="level2">
<h2 class="anchored" data-anchor-id="des-health-policy-terminology-mapping">DES / Health Policy Terminology Mapping</h2>
<p>A simulation in DES involves multiple trajectories running in parallel. In the health policy framework the Objective is to evaluate health outcomes of patients moving through different health strategies. This translates to trajectory == patient. Simulation is usually a single strategy. The <code>simmer::env</code> is the global environment, or health system of the simulation.</p>
<p>A trajectory has attributes, which are intended to represent the state of the patient. At the end of a run, the simmer framework can provide attributes on a patient and resources consumed. Thus attribute == patient state during the simulation and resources == events or counters happening to a patient we wish to evaluate costs or quality of life around.</p>
<p>DES supports the idea of modeling shared resources between patients, e.g.&nbsp;a limited health care system or access to care. The Sick/Sicker and a fair number of models make no use of this capability of DES. This tutorial does not explore shared resource constraints and would be an advanced or follow on topic.</p>
<p>Patients are independent in the Sick/Sicker Model. Thus for events we wish to model, we need two functions: time to event and event handling. Time to event is given the parameters or inputs to the model and returns time to event based on the patient state. Event handling updates the state of the current trajectory by modifying attributes. This can trigger redraws of other events, or not.</p>
</section>
<section id="sicksicker-model" class="level2">
<h2 class="anchored" data-anchor-id="sicksicker-model">Sick/Sicker Model</h2>
<p>Source is <a href="http://htmlpreview.github.io/?https://github.com/spgarbet/CostEffectivenessMN2018/master/Notes-Day1.html">Univ of Minnesota 2018 Workshop</a> provided by the <a href="https://darthworkgroup.com/">DARTH Workgroup</a>.</p>
<p>Notes from Workshop:</p>
<p><img src="./02_model_diagram.png" class="img-fluid"></p>
<blockquote class="blockquote">
<p>In this exercise, we will model a hypothetical disease that affects individuals with an average age of 25 years and results in increased mortality, increased healthcare costs, and reduced quality of life. The disease has two levels; affected individuals initially become sick but can subsequently progress and become sicker. Two alternative strategies exist for this hypothetical disease: a no-treatment and a treatment strategy. Under the treatment strategy, individuals in the sick and sicker states are treated until they recover (only if sick; individuals in the sicker state cannot recover) or die. The cost of the treatment is additive to the baseline healthcare costs of being sick or sicker. The treatment improves quality of life for those individuals who are sick but has no impact on the quality of life of those who are sicker. Unfortunately, it is not possible to reliably differentiate between people in the sick and sicker states, so treatment cannot be targeted to only those in the sick state. You are asked to evaluate the cost-effectiveness of the treatment.</p>
<p>To model this disease, we will rely on a state-transition cohort model, called the Sick-Sicker model, first described by Enns et al.&nbsp;The Sick-Sicker model consists of four health states: Healthy (H), two disease states, Sick (S1) and Sicker (S2), and Dead (D) (Figure 1). All individuals start in the Healthy state. Over time, healthy individuals may develop the disease and can progress to S1. Individuals in S1 can recover (return to state H), progress further to S2 or die. Individuals in S2 cannot recover (i.e.&nbsp;cannot transition to either S1 or H). Individuals in H have a baseline probability of death; individuals in S1 and S2 experience increased mortality compared to those in the H state, given in terms of hazard ratios. These ratios are used to calculate the probabilities of dying when in S1 and S2.</p>
<p>Enns, E A, L E Cipriano, C T Simons, and C Y Kong. 2015. “Identifying Best-Fitting Inputs in Health-Economic Model Calibration: A Pareto Frontier Approach.” Medical Decision Making 35 (2): 170–82. <a href="https://doi.org/10.1177/0272989X14528382">doi:10.1177/0272989X14528382</a>.</p>
</blockquote>
<p>See also: <a href="https://darth-git.github.io/darthpack/articles/aa-introduction.html">darthpack</a></p>
</section>
<section id="model-1-premiers-pas" class="level2">
<h2 class="anchored" data-anchor-id="model-1-premiers-pas">Model 1 (<em>Premiers pas</em>)</h2>
<p>Objective: A DES model that runs patients through a simulation till the time horizon is reached and does nothing else.</p>
<p><a href="https://medium.com/publishous/the-little-known-power-of-going-slow-to-go-fast-2ce0ea0b8bff"><em>The Little-Known Power of Going Slow to Go Fast</em></a></p>
<p>Getting such a simple model running is an important step to see the basic framework of constructing a model. A classic beginner mistake is to attempt to code an entire model in one go without building it up slowly step by step. Debugging a massive pile of code is daunting task. Avoid doing this and keep your model running with each additional step taken in model construction. This framework provided allows a lot of modularity of adding and subtracting events.</p>
<p>Further the ability to audit and see what happens to a single patient in a simulation is crucial to success. Without being able to see the individual and how they progress through a simulation and the ability to locate interesting trajectories it is near impossible to know when success has been achieved.</p>
<p>The first step in this tutorial for simplicity is to include the DARTH rates of the Sick/Sicker model in <code>inputs.R</code>.</p>
<pre><code>inputs &lt;- list(
    N      = 5,
  
    # Parameters (1 cycle == 1 year)
    horizon=    30,      # Time horizon in years
    
    d.r    =     0.03,   # Discount Rate
    
    r.HS1  =     0.15,   # Disease Onset Rate / year       (H  -&gt; S1)
    r.S1H  =     0.7,    # Recovery Rate / year            (S1 -&gt; H)
    r.S1S2 =     0.10,   # Disease Progression rate / year (S1 -&gt; S2)
    r.HD   =     0.005,  # Healthy to Dead rate / year     (H  -&gt; D)
    hr.S1D =     3,      # Hazard ratio in S1 vs healthy 
    hr.S2D =    10,      # Hazard ratio in S2 vs healthy
    hr.cor =     2,      # Hazard ratio of a condition giving the other condition.
    
    # Annual Costs
    c.H    =  2000,      # Healthy individuals 
    c.S1   =  4000,      # Sick individuals in S1
    c.S2   = 15000,      # Sick individuals in S2
    c.D    =     0,      # Dead individuals
    c.Trt  = 12000,      # Additional Annual cost for S1 and S2
    
    # Utility Weights
    u.H    =     1.00,   # Healthy
    u.S1   =     0.80,   # S1
    u.S2   =     0.60,   # S2
    u.D    =     0.00,   # Dead
    
    # Intervention Effect
    u.Trt  =     0.95,   # S1 Utility for treatment in S1
    
    wtp    = 1e5,
    
    strategy = 'notreat' # Default strategy is to do nothing
  )
</code></pre>
<p>This is mostly lifted from our example source and the model definition and reading up on Sick/Sicker is an exercise for the reader using the materials in the previous section.</p>
<p>The next part is really simple. Including <code>main_loop.R</code> in ones code gives the essential framework to build a model using simmer. This code allows for an event registry that by defining a function that returns time_to_event and a function to deal with resulting state transition if that event fires. It deals with drawing the next event and firing it. This code has remained mostly unchanged for a decade across numerous projects.</p>
<p>Thus the main file to run our model we can now begin construction of <code>model-1.R</code>. The fragments of this file will be described below.</p>
<section id="boilerplate" class="level3">
<h3 class="anchored" data-anchor-id="boilerplate">Boilerplate</h3>
<p>First part is to load necessary bits: <code>simmer</code>, our <code>inputs</code> and the boilerplate <code>main_loop</code>.</p>
<pre><code>library(simmer)

source('inputs.R')     # Your Model Parameters
source('main_loop.R')  # Boilerplate code</code></pre>
</section>
<section id="counters" class="level3">
<h3 class="anchored" data-anchor-id="counters">Counters</h3>
<p>First is to define the resources or things we wish to track about a patient.</p>
<pre><code>counters &lt;- c(
  "time_in_model"
)</code></pre>
<p>This will be used later with a convenience function provided by <code>main_loop</code> to define resources that have infinite capacity, i.e.&nbsp;no resource contention or competition. Our objective is to get a trajectory for a patient to run to the time horizon and we want to track their time in our model. Thus our first <code>counter</code> will be <code>time_in_model</code>.</p>
</section>
<section id="initialize-our-patient" class="level3">
<h3 class="anchored" data-anchor-id="initialize-our-patient">Initialize our patient</h3>
<p>We need a function to define the starting state of a patient. This can be arbitrary complex as needed to define the attributes of the starting population of a study.</p>
<p><strong>NOTE</strong>: It is important when using simmer to mostly pass functions for defining things in a trajectory. This is a call back, and if not done properly it can result in puzzling behavior. If one passed to simmer the following: <code>sample(20:30,1)</code>, it would result in a single random draw applied to every single patient. For example, if 25 were draw every patient would be 25. Instead one needs to pass to simmer <code>function() sample(20:30,1)</code> to get a random draw for each patient resulting a uniform spread of this parameter. If every patient had the same attribute being assigned, it would be fine to leave off the <code>function()</code>, but this can lead to forgetting to do it in cases where it’s needed and it doesn’t hurt to leave it in on all calls.</p>
<pre><code>initialize_patient &lt;- function(traj, inputs)
{
  traj                   |&gt;
  seize("time_in_model") |&gt;
  set_attribute("AgeInitial", function() sample(20:30, 1))
}</code></pre>
<p>This function expects a patient trajectory and the inputs to be provided. Using this trajectory it seizes the counter “time_in_model” simply stating that patient is taking time inside a model. We follow with an example function of setting an attribute “AgeInitial”. This isn’t utilized in Sick/Sicker and is only for example purposes of setting.</p>
</section>
<section id="release-resources-on-exit" class="level3">
<h3 class="anchored" data-anchor-id="release-resources-on-exit">Release Resources on Exit</h3>
<p>When a patient leaves the simulation via any means it is helpful to have a function that examines the state or attributes of that patient/trajectory and releases any resources they used.</p>
<p>In this section, we know they’ve seized <code>time_in_model</code>, so they need to let that go when they exit.</p>
<pre><code>cleanup_on_termination &lt;- function(traj)
{
  traj |&gt; 
  release("time_in_model")
}</code></pre>
<p>This function can get a lot more complex as patient state grows more complex.</p>
</section>
<section id="termination-routine" class="level3">
<h3 class="anchored" data-anchor-id="termination-routine">Termination Routine</h3>
<p>This routine terminates the trajectory and calls the above cleanup. These two pieces could easily have been one function, but keeping them separate has proven useful in practice, primarily for organizational purposes.</p>
<pre><code>terminate_simulation &lt;- function(traj, inputs)
{
  traj |&gt;
  branch( function() 1, 
          continue=FALSE,
          trajectory() |&gt; cleanup_on_termination()
        )
}</code></pre>
</section>
<section id="event-registry" class="level3">
<h3 class="anchored" data-anchor-id="event-registry">Event Registry</h3>
<p>Now we’re approaching the heart of the model. The event registry. We’re going to define a single event to terminate the patient trajectory when the defined time horizon is reached. For a full life simulation such a function isn’t needed as a proper mortality model would have individuals simulated die at some point, however it’s not bad to have something like this to prevent a run away simulation.</p>
<p>Here’s how it looks for a single entry.</p>
<pre><code># Main Event registry
event_registry &lt;- list(
  list(name          = "Terminate at time horizon",
       attr          = "aTerminate",
       time_to_event = function(inputs) inputs$horizon,
       func          = terminate_simulation,
       reactive      = FALSE)
)</code></pre>
<p>The <code>name</code> field is for debugging purposes and may come up on a simmer trace. It’s not used much in practice. The <code>attr</code> is the name of the attribute on a patient used to store the time to event. It needs to be unique and not correspond to any other attribute name defined on the patient. The <code>time_to_event</code> is a call back function that defines how long till the event occurs. Simulation time starts at 0 and proceeds forward. In this Sick/Sicker model we have chosen the cycle to each a year. Thus when time reaches 2.0, that’s 2 years into the simulation for that patient–<em>not their_age</em>. The <code>func</code> is the callback function that will modify the state of the patient, in this case it’s the terminate simulation function defined above. The <code>reactive</code> field is a logical TRUE/FALSE that defines whether all other events should be redraw if this event fires. In this case the patient trajectory is ending, so no events for them should be redrawn.</p>
</section>
</section>
<section id="des-simulation" class="level2">
<h2 class="anchored" data-anchor-id="des-simulation">DES Simulation</h2>
<p>Now, to pull it together in a simmer simulation.</p>
<pre><code>des_run &lt;- function(inputs)
{
  env  &lt;&lt;- simmer("SickSicker")
  traj &lt;- des(env, inputs)
  env |&gt; 
    create_counters(counters) |&gt;
    add_generator("patient", traj, at(rep(0, inputs$N)), mon=2) |&gt;
    run(inputs$horizon+1/365) |&gt; # Simulate just past horizon (in years)
    wrap()
        
  get_mon_arrivals(env, per_resource = T)
}</code></pre>
<p>The first step is to create a global environment used to run simmer. This is followed by creating a des definition of a trajectory (this function is in <code>main_loop</code>. It uses the things we’ve defined above.</p>
<p>Then the env is given resources or counters, patients are generated into the simulation, the simulation is run for an amount of time (just past the horizon) and then the <code>wrap</code> makes sure all summaries are ready.</p>
<p><code>get_mon_arrival</code> returns us the trajectories of the patients in a data.frame. We will expand on this quite a bit later. It really the soul of understanding what’s going on in a simulation and critical for auditing and validation of expectations about a model as we demonstrate later.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'model-1.R'</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">des_run</span>(inputs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      name start_time end_time activity_time      resource replication
1 patient0          0       30            30 time_in_model           1
2 patient1          0       30            30 time_in_model           1
3 patient2          0       30            30 time_in_model           1
4 patient3          0       30            30 time_in_model           1
5 patient4          0       30            30 time_in_model           1</code></pre>
</div>
</div>
<p>These are called ‘arrivals’ in DES parlance.</p>
<p>There it is, 5 patients who are simulated independently for 30 years. One can see the name of the trajectory, which we’ve used ‘patient0’, the start_time and end_time for a resource–of each patient we’ve used one. They start the simulation at time 0 and end at time 30. The <code>activity_time</code> spent in the model is 30. The only resource used at this point is the only one we’ve defined, <code>time_in_model</code>. The replication is 1, is we were doing multiple runs and accumulating them.</p>
<p>While simple, just getting a framework up and running is an accomplishment. Relax and get a cup of tea, the first step is over.</p>
</section>
<section id="model-2" class="level2">
<h2 class="anchored" data-anchor-id="model-2">Model 2</h2>
<p>Objective: Add in cost / quality accumulators</p>
<p>At this point there’s not much to accumulate, but once again we’re taking really small steps toward our goal. The existing model code doesn’t change much but we need to add accumulators for showing cost and quality.</p>
<section id="discounting" class="level3">
<h3 class="anchored" data-anchor-id="discounting">Discounting</h3>
<p>A small diversion is we need to be able to apply <a href="https://en.wikipedia.org/wiki/Discounting">discounting</a> to our results. Thus a numerically stable and vectorized version of discounting is just the ticket. The file <a href="./discount.R"><code>discount.R</code></a> contains what’s required. Other common versions utilize the power definition of discounting, this uses the “^” operator which limits the numerical stable range of the function. Our function uses the exponential formulation with a greater numerical stability. The function also does point discounting or integrated area discounted.</p>
<section id="examples" class="level4">
<h4 class="anchored" data-anchor-id="examples">Examples</h4>
<p>Discount the value 1 at 1 year in the future at a default rate of 0.03. This is a point in time discount.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'discount.R'</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">discount_value</span>(<span class="dv">1</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9708738</code></pre>
</div>
</div>
<p>Integrate the discounted value 1 over the time period from 0 to 1. This is the area under the discount curve over that time period.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">discount_value</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9853651</code></pre>
</div>
</div>
<p>Vectorized R calls that can be used inside numerical optimizers is important for more complex models. Demonstration of discounting the value 1 over two ranges, [0,365] and [125,490] using a discount rate of 0.04, and units passed in are 365 days of a year.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">discount_value</span>(<span class="dv">1</span>, <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">125</span>), <span class="fu">c</span>(<span class="dv">365</span>, <span class="dv">490</span>), <span class="fl">0.04</span>, <span class="dv">365</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9806435 0.9675598</code></pre>
</div>
</div>
</section>
</section>
<section id="cost-model" class="level3">
<h3 class="anchored" data-anchor-id="cost-model">Cost Model</h3>
<p>We need to define incured costs for our model. It should take the <code>data.frame</code> from <code>des_run</code> and add cost columns for the resources. We pass in the inputs as they might be needed. We will ignore the costs for healthy till we can add that state later.</p>
<pre><code>cost_arrivals &lt;- function(arrivals, inputs)
{
  arrivals$cost  &lt;- 0  # No costs yet
  arrivals$dcost &lt;- 0  # No discounted costs either
  
  arrivals
}</code></pre>
</section>
<section id="utility-or-quality-of-life" class="level3">
<h3 class="anchored" data-anchor-id="utility-or-quality-of-life">Utility or Quality of Life</h3>
<p>Our patients in the model are healthy and enjoy a full quality of life, measured in quality life years. We define their time in the model as a utility of 1 and then integrate how much utility they experience in their life.</p>
<pre><code>qaly_arrivals &lt;- function(arrivals, inputs)
{
  arrivals$qaly  &lt;- 0  # No qaly yet
  arrivals$dqaly &lt;- 0  # No discounted qaly either
  
  selector &lt;- arrivals$resource == 'time_in_model'
  arrivals$qaly[selector] &lt;-
    arrivals$end_time[selector] - 
    arrivals$start_time[selector]
  arrivals$dqaly[selector] &lt;- 
      discount_value(1, 
                     arrivals$start_time[selector],
                     arrivals$end_time[selector])
    
  arrivals
}</code></pre>
</section>
<section id="pull-it-together" class="level3">
<h3 class="anchored" data-anchor-id="pull-it-together">Pull it together</h3>
<p>With those functions added, we can modify the last line of the <code>des_run</code> function in our model to apply them on what we get from the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'model-2.R'</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">des_run</span>(inputs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      name start_time end_time activity_time      resource replication cost
1 patient0          0       30            30 time_in_model           1    0
2 patient1          0       30            30 time_in_model           1    0
3 patient2          0       30            30 time_in_model           1    0
4 patient3          0       30            30 time_in_model           1    0
5 patient4          0       30            30 time_in_model           1    0
  dcost qaly  dqaly
1     0   30 19.893
2     0   30 19.893
3     0   30 19.893
4     0   30 19.893
5     0   30 19.893</code></pre>
</div>
</div>
<p>One can now see the integration of qaly and dqaly, which is the total amount of QALY an individual in the simulation accumulates.</p>
<p>Not a very exciting model, but the foundation is solid. One can see exactly what’s going on in this small sample.</p>
</section>
</section>
<section id="model-3" class="level2">
<h2 class="anchored" data-anchor-id="model-3">Model 3</h2>
<p>Objective: A DES model that now includes the death event transition as defined by Sick/Sicker.</p>
<p>The Sick/Sicker mortality model is a simple exponential draw. Not a very robust mortality model, but for demonstration purposes is sufficient.</p>
<p>I prefer keeping events in files starting with <code>event_</code> for organization and quick identification purposes. We need an event for death, so let’s use <code>event_death.R</code> and define the time_to_death draw function.</p>
<pre><code>years_till_death &lt;- function(inputs)
{
  rexp(1, inputs$r.HD)
}</code></pre>
<p>When a death occurs an update to the patient trajectory needs to be made.</p>
<pre><code>death &lt;- function(traj, inputs)
{
  traj |&gt; branch(
    function() 1,
    continue=c(FALSE), # False is patient death, had to use a branch to force termination
    trajectory("Death") |&gt;
      mark("death")     |&gt; # Must be in 'counters'
      terminate_simulation()
  )
}</code></pre>
<p>Next we add this to the <code>event_registry</code>.</p>
<pre><code>event_registry &lt;- list(
  list(name          = "Terminate at time horizon",
       attr          = "aTerminate",
       time_to_event = function(inputs) inputs$horizon,
       func          = terminate_simulation,
       reactive      = FALSE),
  list(name          = "Death",
       attr          = "aDeath",
       time_to_event = years_till_death,
       func          = death,
       reactive      = TRUE)
)</code></pre>
<p>Go back and add the <code>death</code> counter, and source the event file and death is implemented.</p>
<p>Here we specified “reactive” for the event. This means that when and event is triggered, this needs to redraw or reevaluate when this event will trigger. At this point in time it doesn’t affect the model, but the specification has differing death rates with hazard ratios based on the patient state. For example if the patient in a trajectory changes from healthy to sick their death rate changes based on a hazard ratio. This means that their time to death will change. Marking the event as reactive ensures that the reevaluation happens.</p>
<p>The reactive flag doesn’t need to be used and the redraw of the event time could happen inside the event handling. However, this clutters up events and forces them to deal with other events – which might not be in the event registry table. But utilizing the flag it keeps the model modular, the downside is every reactive event get reevaluated whether it needs to be done for a given event.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'model-3.R'</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">des_run</span>(inputs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      name start_time end_time activity_time      resource replication cost
1 patient1   27.95905 27.95905       0.00000         death           1    0
2 patient1    0.00000 27.95905      27.95905 time_in_model           1    0
3 patient0    0.00000 30.00000      30.00000 time_in_model           1    0
4 patient2    0.00000 30.00000      30.00000 time_in_model           1    0
5 patient3    0.00000 30.00000      30.00000 time_in_model           1    0
6 patient4    0.00000 30.00000      30.00000 time_in_model           1    0
  dcost     qaly    dqaly
1     0  0.00000  0.00000
2     0 27.95905 19.02628
3     0 30.00000 19.89300
4     0 30.00000 19.89300
5     0 30.00000 19.89300
6     0 30.00000 19.89300</code></pre>
</div>
</div>
<p>This shows a death event occurring for patient 1. Note the ordering by patient isn’t guaranteed. Patient 1 also doesn’t get as much QALY as the other patients due to existing the model early.</p>
</section>
<section id="model-4" class="level2">
<h2 class="anchored" data-anchor-id="model-4">Model 4</h2>
<p>Objective: A DES model that now adds the Sick State transition</p>
<p>This is the thick of it. We have a lot of proper model work now that the framework is up and running and the basic functions / layout is defined. This is a critical step in model construction and it cannot be understated how carefully this step must be considered and that is the definition of the state model. While the state diagram is provided for the Sick/Sicker when constructing a novel model, must look at existing literature and experts and carefully construct a state model of a patient. State modeling is a know combinatorial complex process, and it is very easy to make it too complicated and in construction it is almost certain to have missed transitions. A lot of coding work follows from the decision on state and changing it later carries a large cost in time.</p>
<p>With the thoroughly reviewed and making sure it is the minimum to answer the question and corresponds to the literature, we proceed to implement the state model by defining integers that correspond to states. Ths isn’t code but a map to the coding. Note that one for dead is not needed as this exits the simulation. Also, this coding is needed as <code>simmer</code> can only store numeric information as an attribute on a trajectory.</p>
<pre><code>0=H
1=S1
2=S2</code></pre>
<p>Next we need to modify the initialization of the patient to be healthy.</p>
<pre><code>initialize_patient &lt;- function(traj, inputs)
{
  traj                   |&gt;
  seize("time_in_model") |&gt;
  set_attribute("AgeInitial", function() sample(20:30, 1)) |&gt;
  set_attribute("State", 0) |&gt; # Patients start healthy
  seize("healthy") 
}</code></pre>
<p>Being in Sick1 has a disutility to life and incurs costs we’d like to track and accumulate those measure for that state, thus a new counter is needed.</p>
<pre><code>counters &lt;- c(
  "time_in_model",
  "death",
  "healthy",
  "sick1"
)</code></pre>
<p>Now 2 events or transitions are needed: <code>event_sick1</code> and <code>event_healthy</code> (the transition back). Here’s <code>event_sick1</code>:</p>
<pre><code>years_till_sick1 &lt;- function(inputs)
{
  state &lt;- get_attribute(env, "State") 
  if(state == 0) # 0 =&gt; Healthy
  {
    rexp(1,inputs$r.HS1)
  } else
  {
    inputs$horizon+1 # Past end of simulation time
  }
}

sick1 &lt;- function(traj, inputs)
{
  traj                      |&gt; 
  set_attribute("State", 1) |&gt; # 1 =&gt; Sick 1 (S1)
  release('healthy')        |&gt; # Track state change for tally later
  seize('sick1')
}
</code></pre>
<p>At this point we can drop the new event in our event registry and the model can be run as a check.</p>
<pre><code>  list(name          = "Sick1",
       attr          = "aSick1",
       time_to_event = years_till_sick1,
       func          = sick1,
       reactive      = TRUE)</code></pre>
<p>In constructions of this tutorial, the author encountered two errors due to typos at this point, and got this warning message:</p>
<pre><code>Warning messages:
1: In run_(.env$sim_obj, until) :
  'patient0': leaving without releasing 'sick1'
2: In run_(.env$sim_obj, until) :
  'patient4': leaving without releasing 'sick1'
3: In run_(.env$sim_obj, until) :
  'patient1': leaving without releasing 'sick1'
4: In run_(.env$sim_obj, until) :
  'patient3': leaving without releasing 'sick1'
5: In run_(.env$sim_obj, until) :
  'patient2': leaving without releasing 'sick1'</code></pre>
<p>This is saying that the 5 trajectories seized the sick1 resource and when terminated didn’t cleanup. We can go back and modify the cleanup.</p>
<pre><code>cleanup_on_termination &lt;- function(traj)
{
  traj |&gt; 
  release("time_in_model") |&gt;
  branch( 
    function() get_attribute(env, "State")+1,
      continue = rep(TRUE, 3),
      trajectory() |&gt; release("healthy"),
      trajectory() |&gt; release("sick1"), # Leaving sick1 state on termination
      trajectory()      # Future Sick2 state
  )
}</code></pre>
<p>The <code>event_death::time_to_death</code> needs to be modified to account for state as the hazard rate changes based on state. For this tutorial we used <code>event_death2.R</code>, to keep all the files in one directory. For a well run, best practices project, learn and use git and between each of this steps just <code>git</code> do it’s job and keep track of all your versions.</p>
<pre><code>years_till_death &lt;- function(inputs)
{
  state &lt;- get_attribute(env, "State")
  rate &lt;- inputs$r.HD
  if(state == 1) rate &lt;- rate * inputs$hr.S1D # Deal with Sick1 Hazard Ratio
  rexp(1, rate)
}</code></pre>
<p>Next let’s update the cost accumulation to use the inputs for these 2 states that exist.</p>
<pre><code>cost_arrivals &lt;- function(arrivals, inputs)
{
  arrivals$cost  &lt;- 0  # No costs yet
  arrivals$dcost &lt;- 0  # No discounted costs either
  
  selector = arrivals$resource == 'healthy'
  arrivals$cost[selector] &lt;- inputs$c.H *
    (arrivals$end_time[selector] - arrivals$start_time[selector])
  arrivals$dcost[selector] &lt;- discount_value(inputs$c.H,
    arrivals$start_time[selector], arrivals$end_time[selector])
  
  selector = arrivals$resource == 'sick1'
  arrivals$cost[selector] &lt;- inputs$c.S1 *
    (arrivals$end_time[selector] - arrivals$start_time[selector])
  arrivals$dcost[selector] &lt;- discount_value(inputs$c.S1,
    arrivals$start_time[selector], arrivals$end_time[selector])
 
  arrivals
}</code></pre>
<p>Similarly update the QALY accumulation, but switch from using time in model to using the utilities defined in input.</p>
<pre><code>
qaly_arrivals &lt;- function(arrivals, inputs)
{
  arrivals$qaly  &lt;- 0  # No qaly yet
  arrivals$dqaly &lt;- 0  # No discounted qaly either
  
  selector &lt;- arrivals$resource == 'healthy'
  arrivals$qaly[selector] &lt;-
    inputs$u.H*
     (arrivals$end_time[selector] - arrivals$start_time[selector])
  arrivals$dqaly[selector] &lt;- 
      discount_value(inputs$u.H, 
                     arrivals$start_time[selector],
                     arrivals$end_time[selector])
  
  selector &lt;- arrivals$resource == 'sick1'
  arrivals$qaly[selector] &lt;-
    inputs$u.S1*
     (arrivals$end_time[selector] - arrivals$start_time[selector])
  arrivals$dqaly[selector] &lt;- 
      discount_value(inputs$u.S1, 
                     arrivals$start_time[selector],
                     arrivals$end_time[selector])
  
  arrivals
}</code></pre>
<p>Now a run is in order.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">3</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'model-4.R'</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">des_run</span>(inputs)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       name  start_time    end_time activity_time      resource replication
1  patient3  0.00000000  0.06698552    0.06698552       healthy           1
2  patient4  0.00000000  0.51500444    0.51500444       healthy           1
3  patient2  0.00000000  1.03479892    1.03479892       healthy           1
4  patient1  0.00000000  1.39192072    1.39192072       healthy           1
5  patient0  0.00000000  8.21944391    8.21944391       healthy           1
6  patient4 11.06017048 11.06017048    0.00000000         death           1
7  patient4  0.00000000 11.06017048   11.06017048 time_in_model           1
8  patient4  0.51500444 11.06017048   10.54516604         sick1           1
9  patient0 21.51698600 21.51698600    0.00000000         death           1
10 patient0  0.00000000 21.51698600   21.51698600 time_in_model           1
11 patient0  8.21944391 21.51698600   13.29754209         sick1           1
12 patient3 27.22543337 27.22543337    0.00000000         death           1
13 patient3  0.00000000 27.22543337   27.22543337 time_in_model           1
14 patient3  0.06698552 27.22543337   27.15844785         sick1           1
15 patient2  0.00000000 30.00000000   30.00000000 time_in_model           1
16 patient1  0.00000000 30.00000000   30.00000000 time_in_model           1
17 patient2  1.03479892 30.00000000   28.96520108         sick1           1
18 patient1  1.39192072 30.00000000   28.60807928         sick1           1
         cost      dcost        qaly       dqaly
1     133.971   133.8385  0.06698552  0.06691925
2    1030.009  1022.2086  0.51500444  0.51110432
3    2069.598  2038.2663  1.03479892  1.01913314
4    2783.841  2727.3503  1.39192072  1.36367517
5   16438.888 14594.2785  8.21944391  7.29713927
6       0.000     0.0000  0.00000000  0.00000000
7       0.000     0.0000  0.00000000  0.00000000
8   42180.664 35692.2209  8.43613283  7.13844418
9       0.000     0.0000  0.00000000  0.00000000
10      0.000     0.0000  0.00000000  0.00000000
11  53190.168 34495.0557 10.63803367  6.89901115
12      0.000     0.0000  0.00000000  0.00000000
13      0.000     0.0000  0.00000000  0.00000000
14 108633.791 74539.2546 21.72675828 14.90785093
15      0.000     0.0000  0.00000000  0.00000000
16      0.000     0.0000  0.00000000  0.00000000
17 115860.804 75495.4658 23.17216086 15.09909315
18 114432.317 74117.2976 22.88646342 14.82345953</code></pre>
</div>
</div>
<p>The results are lot more complicated and harder to interpret. To bring some order to what’s happening what we can do is now randomly audit patients.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">6</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>pn <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>inputs<span class="sc">$</span>N, <span class="dv">1</span>) <span class="sc">-</span> <span class="dv">1</span> <span class="co"># Starts a zero</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>audit <span class="ot">&lt;-</span> results[results<span class="sc">$</span>name <span class="sc">==</span> <span class="fu">paste0</span>(<span class="st">'patient'</span>,pn),]</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>audit[<span class="fu">order</span>(audit<span class="sc">$</span>start_time, audit<span class="sc">$</span>end_time),] <span class="co"># For clarity</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      name start_time   end_time activity_time      resource replication
2 patient4  0.0000000  0.5150044     0.5150044       healthy           1
7 patient4  0.0000000 11.0601705    11.0601705 time_in_model           1
8 patient4  0.5150044 11.0601705    10.5451660         sick1           1
6 patient4 11.0601705 11.0601705     0.0000000         death           1
       cost     dcost      qaly     dqaly
2  1030.009  1022.209 0.5150044 0.5111043
7     0.000     0.000 0.0000000 0.0000000
8 42180.664 35692.221 8.4361328 7.1384442
6     0.000     0.000 0.0000000 0.0000000</code></pre>
</div>
</div>
<p>The random audit (the set.seed is just so we can reproduce the result and discuss here, remove it to be truly random), shows that Patient trajectory 2 in this simulation is health for 3/4 of the year. His time in the model is cut short to just under 20 years. He spends most of that time in the S1 state until his death.</p>
<p>The ability to audit random patients is vital to model validation that it is performing as expected. One can do things like find a patient based on a desired event in a trajectory. Let’s look for a patient who died.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>pn <span class="ot">&lt;-</span> <span class="fu">sample</span>(results[results<span class="sc">$</span>resource<span class="sc">==</span><span class="st">'death'</span>,<span class="st">'name'</span>],<span class="dv">1</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>results[results<span class="sc">$</span>name <span class="sc">==</span> pn, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       name start_time  end_time activity_time      resource replication
5  patient0   0.000000  8.219444      8.219444       healthy           1
9  patient0  21.516986 21.516986      0.000000         death           1
10 patient0   0.000000 21.516986     21.516986 time_in_model           1
11 patient0   8.219444 21.516986     13.297542         sick1           1
       cost    dcost      qaly    dqaly
5  16438.89 14594.28  8.219444 7.297139
9      0.00     0.00  0.000000 0.000000
10     0.00     0.00  0.000000 0.000000
11 53190.17 34495.06 10.638034 6.899011</code></pre>
</div>
</div>
<p>Thus tools to grab and look at trajectories containing specific events randomly auditing and verifying the expected costs and qualitys can be done.</p>
</section>
<section id="model-5" class="level2">
<h2 class="anchored" data-anchor-id="model-5">Model 5</h2>
<p>Objective: Add the return to Healthy from Sick1.</p>
<p>This is adding another event, <code>event_healthy</code> to our project.</p>
<pre><code>
years_till_healthy &lt;- function(inputs)
{
  state &lt;- get_attribute(env, "State") 
  if(state == 1) # 1 =&gt; Sick 1
  {
    rexp(1,inputs$r.S1H)
  } else
  {
    inputs$horizon+1 # Past end of simulation time
  }
}

healthy &lt;- function(traj, inputs)
{
  traj                      |&gt; 
  set_attribute("State", 0) |&gt; # 0 =&gt; Healthy (H)
  seize('healthy')          |&gt;
  release('sick1')
}</code></pre>
<p>Source it and update the event registry.</p>
<pre><code>  list(name          = "Healthy",
       attr          = "aHealthy",
       time_to_event = years_till_healthy,
       func          = healthy,
       reactive      = TRUE)</code></pre>
<p>Now the pattern is becoming familar. Let’s run and check.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'model-5.R'</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">des_run</span>(inputs)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>audit <span class="ot">&lt;-</span> results[results<span class="sc">$</span>name <span class="sc">==</span> <span class="st">'patient1'</span>,]</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>audit[<span class="fu">order</span>(audit<span class="sc">$</span>start_time, audit<span class="sc">$</span>end_time),]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       name start_time  end_time activity_time      resource replication
9  patient1   0.000000  4.899055    4.89905511       healthy           1
48 patient1   0.000000 30.000000   30.00000000 time_in_model           1
13 patient1   4.899055  7.470293    2.57123764         sick1           1
17 patient1   7.470293 11.542523    4.07223050       healthy           1
18 patient1  11.542523 11.600571    0.05804809         sick1           1
21 patient1  11.600571 12.498444    0.89787306       healthy           1
24 patient1  12.498444 13.256838    0.75839345         sick1           1
33 patient1  13.256838 20.532096    7.27525846       healthy           1
36 patient1  20.532096 21.534997    1.00290072         sick1           1
53 patient1  21.534997 30.000000    8.46500296       healthy           1
         cost     dcost       qaly      dqaly
9   9798.1102 9121.7168 4.89905511 4.56085838
48     0.0000    0.0000 0.00000000 0.00000000
13 10284.9506 8568.6555 2.05699011 1.71373110
17  8144.4610 6153.0240 4.07223050 3.07651200
18   232.1924  164.9307 0.04643847 0.03298614
21  1795.7461 1257.6953 0.89787306 0.62884766
24  3033.5738 2073.2443 0.60671476 0.41464887
33 14550.5169 8847.8321 7.27525846 4.42391604
36  4011.6029 2154.3758 0.80232057 0.43087517
53 16930.0059 7925.1278 8.46500296 3.96256391</code></pre>
</div>
</div>
<p>Now the patient bounces back and forth between healthy and sick. The costs and qalys stay the same. The model is nearly complete.</p>
</section>
<section id="model-6" class="level2">
<h2 class="anchored" data-anchor-id="model-6">Model 6</h2>
<p>Objective: Add in the Sick2 state.</p>
<p>Add a sick2 counter.</p>
<pre><code>counters &lt;- c(
  "time_in_model",
  "death",
  "healthy",
  "sick1",
  "sick2"
)</code></pre>
<p>Create <code>event_sick2.R</code></p>
<pre><code>years_till_sick2 &lt;- function(inputs)
{
  state &lt;- get_attribute(env, "State") 
  if(state == 1) # 1 =&gt; Sick1
  {
    rexp(1,inputs$r.S1S2)
  } else
  {
    inputs$horizon+1 # Past end of simulation time
  }
}

sick2 &lt;- function(traj, inputs)
{
  traj                      |&gt; 
  set_attribute("State", 2) |&gt; # 2 =&gt; Sick 2 (S2)
  release('sick1')          |&gt; # Track state change for tally later
  seize('sick2')
}</code></pre>
<p>Make sure it’s released on exit</p>
<pre><code>cleanup_on_termination &lt;- function(traj)
{
  traj |&gt; 
  release("time_in_model") |&gt;
  branch( 
    function() get_attribute(env, "State")+1,
      continue = rep(TRUE, 3),
      trajectory() |&gt; release("healthy"),
      trajectory() |&gt; release("sick1"),
      trajectory() |&gt; release("sick2")  
  )
}</code></pre>
<p>Modify costs</p>
<pre><code>  selector = arrivals$resource == 'sick2'
  arrivals$cost[selector] &lt;- inputs$c.S2 *
    (arrivals$end_time[selector] - arrivals$start_time[selector])
  arrivals$dcost[selector] &lt;- discount_value(inputs$c.S2,
    arrivals$start_time[selector], arrivals$end_time[selector])
 </code></pre>
<p>Modify QALY</p>
<pre><code>  selector &lt;- arrivals$resource == 'sick2'
  arrivals$qaly[selector] &lt;-
    inputs$u.S2*
     (arrivals$end_time[selector] - arrivals$start_time[selector])
  arrivals$dqaly[selector] &lt;- 
      discount_value(inputs$u.S2, 
                     arrivals$start_time[selector],
                     arrivals$end_time[selector])
  </code></pre>
<p>Modify the <code>event_death</code> (here in <code>event_death3.R</code>)</p>
<pre><code>years_till_death &lt;- function(inputs)
{
  state &lt;- get_attribute(env, "State")
  rate &lt;- inputs$r.HD
  if(state == 1) rate &lt;- rate * inputs$hr.S1D # Deal with Sick1 Hazard Ratio
  if(state == 2) rate &lt;- rate * inputs$hr.S2D
  rexp(1, rate)
}</code></pre>
<p>Let’s see if we can audit a trajectory with sick2.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'model-6.R'</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">des_run</span>(inputs)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>pn <span class="ot">&lt;-</span> results<span class="sc">$</span>name[results<span class="sc">$</span>resource <span class="sc">==</span> <span class="st">'sick2'</span>][<span class="dv">1</span>]</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>audit <span class="ot">&lt;-</span> results[results<span class="sc">$</span>name <span class="sc">==</span> pn,]</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>audit[<span class="fu">order</span>(audit<span class="sc">$</span>start_time, audit<span class="sc">$</span>end_time),]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       name start_time  end_time activity_time      resource replication
5  patient1   0.000000  4.445984     4.4459842       healthy           1
28 patient1   0.000000 20.090316    20.0903164 time_in_model           1
11 patient1   4.445984  5.635455     1.1894707         sick1           1
14 patient1   5.635455 11.866599     6.2311438       healthy           1
16 patient1  11.866599 12.265300     0.3987010         sick1           1
19 patient1  12.265300 13.761215     1.4959153       healthy           1
22 patient1  13.761215 15.572232     1.8110174         sick1           1
23 patient1  15.572232 16.563925     0.9916925       healthy           1
24 patient1  16.563925 17.330233     0.7663082         sick1           1
29 patient1  17.330233 20.090316     2.7600832         sick2           1
27 patient1  20.090316 20.090316     0.0000000         death           1
        cost     dcost      qaly     dqaly
5   8891.968  8332.462 4.4459842 4.1662310
28     0.000     0.000 0.0000000 0.0000000
11  4757.883  4099.466 0.9515765 0.8198931
14 12462.288  9635.463 6.2311438 4.8177314
16  1594.804  1116.391 0.3189608 0.2232783
19  2991.831  2036.659 1.4959153 1.0183294
22  7244.070  4696.285 1.4488140 0.9392570
23  1983.385  1233.539 0.9916925 0.6167697
24  3065.233  1857.459 0.6130465 0.3714918
29 41401.249 23820.226 1.6560499 0.9528090
27     0.000     0.000 0.0000000 0.0000000</code></pre>
</div>
</div>
<p>This shows that base case of the Sick/Sicker model is now fully handled.</p>
</section>
<section id="model-7" class="level2">
<h2 class="anchored" data-anchor-id="model-7">Model 7</h2>
<p>Objective: Add treatment strategy to model.</p>
<pre><code>counters &lt;- c(
  "time_in_model",
  "death",
  "healthy",
  "sick1",
  "sick2",
  "treat"
)

initialize_patient &lt;- function(traj, inputs)
{
  traj                   |&gt;
  seize("time_in_model") |&gt;
  set_attribute("AgeInitial", function() sample(20:30, 1)) |&gt;
  set_attribute("State", 0) |&gt; # Patients start healthy
  seize("healthy")       |&gt;
  set_attribute("Treat", function() inputs$strategy == 'treat')
}

# Cleanup function if a termination occurs
# Good for releasing any seized resources based on state.
cleanup_on_termination &lt;- function(traj, inputs)
{
  traj |&gt; 
  release("time_in_model") |&gt;
  branch( 
    function() get_attribute(env, "State")+1,
      continue = rep(TRUE, 3),
      trajectory() |&gt; release("healthy"),
      trajectory() |&gt; release("sick1"),
      trajectory() |&gt; release("sick2") 
  ) |&gt;
  branch( # Assigned to treatment and not healthy
    function() (get_attribute(env, "Treat")  &amp;&amp; 
                get_attribute(env, "State")) + 1,
    continue = rep(TRUE, 2),
    trajectory(),  # No Treatment
    trajectory() |&gt; release('treat')
  )
}</code></pre>
<p>Update costing.</p>
<pre><code>  selector = arrivals$resource == 'treat'
  arrivals$cost[selector] &lt;- inputs$c.Trt *
    (arrivals$end_time[selector] - arrivals$start_time[selector])
  arrivals$dcost[selector] &lt;- discount_value(inputs$c.Trt,
    arrivals$start_time[selector], arrivals$end_time[selector])
 </code></pre>
<p>And modify Quality for S1.</p>
<pre><code>  uS1 &lt;- if(inputs$strategy == 'treat') u.Trt else u.S1
  arrivals$qaly[selector] &lt;-
    uS1*
     (arrivals$end_time[selector] - arrivals$start_time[selector])
  arrivals$dqaly[selector] &lt;- 
      discount_value(uS1, 
                     arrivals$start_time[selector],
                     arrivals$end_time[selector])</code></pre>
<p>Modify both event_sick1 and event_healthy.</p>
<pre><code>sick1 &lt;- function(traj, inputs)
{
  traj                      |&gt; 
  set_attribute("State", 1) |&gt; # 1 =&gt; Sick 1 (S1)
  release('healthy')        |&gt; # Track state change for tally later
  seize('sick1')            |&gt;
  branch( 
    function() get_attribute(env, "Treat")+1,
    continue = rep(TRUE, 2),
    trajectory(),  # No Treatment
    trajectory() |&gt; seize('treat')
  )
}

healthy &lt;- function(traj, inputs)
{
  traj                      |&gt; 
  set_attribute("State", 0) |&gt; # 0 =&gt; Healthy (H)
  seize('healthy')          |&gt;
  release('sick1')          |&gt;
  branch(
    function() get_attribute(env, "Treat") +1,
    continue = rep(TRUE, 2),
    trajectory(),  # No Treatment
    trajectory() |&gt; release('treat')
  )
}</code></pre>
<p>And we can run.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'model-7.R'</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">des_run</span>(inputs)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>pn <span class="ot">&lt;-</span> results<span class="sc">$</span>name[results<span class="sc">$</span>resource <span class="sc">==</span> <span class="st">'sick2'</span>][<span class="dv">1</span>]</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>audit <span class="ot">&lt;-</span> results[results<span class="sc">$</span>name <span class="sc">==</span> pn,]</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>audit[<span class="fu">order</span>(audit<span class="sc">$</span>start_time, audit<span class="sc">$</span>end_time),]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       name start_time  end_time activity_time      resource replication
5  patient1   0.000000  4.445984     4.4459842       healthy           1
28 patient1   0.000000 20.090316    20.0903164 time_in_model           1
11 patient1   4.445984  5.635455     1.1894707         sick1           1
14 patient1   5.635455 11.866599     6.2311438       healthy           1
16 patient1  11.866599 12.265300     0.3987010         sick1           1
19 patient1  12.265300 13.761215     1.4959153       healthy           1
22 patient1  13.761215 15.572232     1.8110174         sick1           1
23 patient1  15.572232 16.563925     0.9916925       healthy           1
24 patient1  16.563925 17.330233     0.7663082         sick1           1
29 patient1  17.330233 20.090316     2.7600832         sick2           1
27 patient1  20.090316 20.090316     0.0000000         death           1
        cost     dcost      qaly     dqaly
5   8891.968  8332.462 4.4459842 4.1662310
28     0.000     0.000 0.0000000 0.0000000
11  4757.883  4099.466 0.9515765 0.8198931
14 12462.288  9635.463 6.2311438 4.8177314
16  1594.804  1116.391 0.3189608 0.2232783
19  2991.831  2036.659 1.4959153 1.0183294
22  7244.070  4696.285 1.4488140 0.9392570
23  1983.385  1233.539 0.9916925 0.6167697
24  3065.233  1857.459 0.6130465 0.3714918
29 41401.249 23820.226 1.6560499 0.9528090
27     0.000     0.000 0.0000000 0.0000000</code></pre>
</div>
</div>
<p>Now with treatment.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>inputs<span class="sc">$</span>strategy <span class="ot">&lt;-</span> <span class="st">'treat'</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">des_run</span>(inputs)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>pn <span class="ot">&lt;-</span> results<span class="sc">$</span>name[results<span class="sc">$</span>resource <span class="sc">==</span> <span class="st">'sick2'</span>][<span class="dv">1</span>]</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>audit <span class="ot">&lt;-</span> results[results<span class="sc">$</span>name <span class="sc">==</span> pn,]</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>audit[<span class="fu">order</span>(audit<span class="sc">$</span>start_time, audit<span class="sc">$</span>end_time),]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       name start_time  end_time activity_time      resource replication
7  patient1   0.000000  4.445984     4.4459842       healthy           1
38 patient1   0.000000 20.090316    20.0903164 time_in_model           1
15 patient1   4.445984  5.635455     1.1894707         sick1           1
16 patient1   4.445984  5.635455     1.1894707         treat           1
19 patient1   5.635455 11.866599     6.2311438       healthy           1
21 patient1  11.866599 12.265300     0.3987010         sick1           1
22 patient1  11.866599 12.265300     0.3987010         treat           1
26 patient1  12.265300 13.761215     1.4959153       healthy           1
30 patient1  13.761215 15.572232     1.8110174         sick1           1
31 patient1  13.761215 15.572232     1.8110174         treat           1
32 patient1  15.572232 16.563925     0.9916925       healthy           1
33 patient1  16.563925 17.330233     0.7663082         sick1           1
40 patient1  16.563925 20.090316     3.5263914         treat           1
39 patient1  17.330233 20.090316     2.7600832         sick2           1
37 patient1  20.090316 20.090316     0.0000000         death           1
        cost     dcost      qaly     dqaly
7   8891.968  8332.462 4.4459842 4.1662310
38     0.000     0.000 0.0000000 0.0000000
15  4757.883  4099.466 1.1299971 0.9736231
16 14273.648 12298.397 0.0000000 0.0000000
19 12462.288  9635.463 6.2311438 4.8177314
21  1594.804  1116.391 0.3787659 0.2651430
22  4784.412  3349.174 0.0000000 0.0000000
26  2991.831  2036.659 1.4959153 1.0183294
30  7244.070  4696.285 1.7204666 1.1153677
31 21732.209 14088.855 0.0000000 0.0000000
32  1983.385  1233.539 0.9916925 0.6167697
33  3065.233  1857.459 0.7279928 0.4411465
40 42316.697 24628.558 0.0000000 0.0000000
39 41401.249 23820.226 1.6560499 0.9528090
37     0.000     0.000 0.0000000 0.0000000</code></pre>
</div>
</div>
<p>Notice patient4 now has higher QALY under treatment, but also has treatment costs.</p>
</section>
<section id="model-8" class="level2">
<h2 class="anchored" data-anchor-id="model-8">Model 8</h2>
<p>Objective: Now compare models and do analysis.</p>
<p>First crank up sample size and then create aggregate measures.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'model-7.R'</span>)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>inputs<span class="sc">$</span>N <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>inputs<span class="sc">$</span>strategy <span class="ot">&lt;-</span> <span class="st">'notreat'</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>results.notreat <span class="ot">&lt;-</span> <span class="fu">des_run</span>(inputs)</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>inputs<span class="sc">$</span>strategy <span class="ot">&lt;-</span> <span class="st">'treat'</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>results.treat <span class="ot">&lt;-</span> <span class="fu">des_run</span>(inputs)</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:simmer':

    select</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>sum.treat <span class="ot">&lt;-</span> </span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  results.treat <span class="sc">|&gt;</span> </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">|&gt;</span> </span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">cost=</span><span class="fu">sum</span>(cost),</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">dcost=</span><span class="fu">sum</span>(dcost),</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">qaly=</span><span class="fu">sum</span>(qaly),</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">dqaly=</span><span class="fu">sum</span>(dqaly))</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>sum.notreat <span class="ot">&lt;-</span> </span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>  results.notreat <span class="sc">|&gt;</span> </span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">|&gt;</span> </span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">cost=</span><span class="fu">sum</span>(cost),</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">dcost=</span><span class="fu">sum</span>(dcost),</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">qaly=</span><span class="fu">sum</span>(qaly),</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">dqaly=</span><span class="fu">sum</span>(dqaly))</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>cea <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">notreat=</span><span class="fu">colMeans</span>(sum.notreat[<span class="fu">c</span>(<span class="st">'cost'</span>, <span class="st">'dcost'</span>, <span class="st">'qaly'</span>, <span class="st">'dqaly'</span>)]),</span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat=</span><span class="fu">colMeans</span>(sum.treat[<span class="fu">c</span>(<span class="st">'cost'</span>, <span class="st">'dcost'</span>, <span class="st">'qaly'</span>, <span class="st">'dqaly'</span>)])</span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>cea</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            cost     dcost     qaly    dqaly
notreat 104647.9  67071.89 23.69394 16.26638
treat   187331.4 119542.72 24.19165 16.60588</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># NHB (discounted)</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="fu">diff</span>(cea[,<span class="st">'dqaly'</span>]) <span class="sc">-</span> <span class="fu">diff</span>(cea[,<span class="st">'dcost'</span>])<span class="sc">/</span>inputs<span class="sc">$</span>wtp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     treat 
-0.1852043 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># NMB (discounted)</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">diff</span>(cea[,<span class="st">'dqaly'</span>])<span class="sc">*</span>inputs<span class="sc">$</span>wtp <span class="sc">-</span> <span class="fu">diff</span>(cea[,<span class="st">'dcost'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    treat 
-18520.43 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ICER</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="fu">diff</span>(cea[,<span class="st">'dcost'</span>])<span class="sc">/</span> <span class="fu">diff</span>(cea[,<span class="st">'dqaly'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   treat 
154551.4 </code></pre>
</div>
</div>
</section>
<section id="aftermatter" class="level2">
<h2 class="anchored" data-anchor-id="aftermatter">Aftermatter</h2>
<p>The first point to be made is the application of new costs and qalys followed the same code pattern with each additional event. If the costs in the <code>inputs</code> were named the same as the <code>resources</code>, these could be applied with a loop. The continued cut and paste of a block of code is the cue to the coder that a function would be easier. It is a recommended exercise to code this and compare results. See <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY</a>. Hint: the inputs lists can contain lists or groupings of parameters to denote how they would be used.</p>
<p>Secondly, the workflow of always keeping a model working with the tiniest steps possible is the fastest path to the goal. Checking each working version into git (and not renaming models like was done here, use git as it was intended), also allows going back and finding where a bug was introduced via <a href="https://git-scm.com/docs/git-bisect"><code>git biset</code></a>.</p>
<p>While the benefits of DES are face validity, the ability to directly utilize hazard rates and survival curves, and deal with very complex patient states that lead to state explosion in Markov models; there are some hidden benefits as well: the ability to model the variability in patient population and model what response to treatment would be expected in a real world population. Here’s a plot of each individuals cost and qaly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rbind</span>(sum.treat, sum.notreat)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>x<span class="sc">$</span>group <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">'treat'</span>, <span class="st">'notreat'</span>), <span class="at">each=</span>inputs<span class="sc">$</span>N)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(x, <span class="fu">aes</span>(<span class="at">x=</span>dqaly, <span class="at">y=</span>dcost, <span class="at">color=</span>group)) <span class="sc">+</span> </span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Sick_Sicker_Simmer_DES_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This plot is odd due to the utilization of simple non realistic exponential rates.</p>
<p>The capability of DES to include constrained resources was not included in this tutorial and would need a separate exploration. The fact that <code>simmer</code> has this capability means that it cannot treat patients as independent in evaluating events. Thus a key feature of <code>simmer</code> is not utilized in independent patient simulations. This feature incurs a computational cost of <span class="math inline">\(\mathcal{O}(n \log n)\)</span>. There is a frameworks written by <a href="https://med.stanford.edu/profiles/fernando-alarid-escudero">Fernando Alarid-Escudero</a> utilizing <code>data.table</code> in R that removes the ability to model constrained resources and reduces the computational cost to <span class="math inline">\(\mathcal{O}(n)\)</span> for this type of modeling. The lessons in this tutorial still apply, but the memory layout of events is in a wide <code>data.table</code>.</p>
<p>To get convergence for studying conditions that are rare events, we have found that we need over 1,000,000 patient trajectories to get convergence of estimators within acceptible statistical bounds. The R <code>simmer</code> framework functions with reasonable speed at no more that 10,000 patient trajectories and possibly less for complex models. We utilize <a href="https://github.com/vubiostat/accre_tutorial">ACCRE</a> to batch the jobs and get sufficient coverage. This is a major issue for performing a probability sensitivity analysis on a model as now a 1000 runs typically need of a 1,000,000 patient trajectories requiring 100,000 job runs! Planning for time to do this is required at project outset.</p>
<p>Shawn Garbett <shawn dot="" garbett="" at="" vumc="" org=""></shawn></p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>